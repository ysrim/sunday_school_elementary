<!DOCTYPE html>
<html xmlns:th="http//www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/layouts/std_layout}">
<script>

	/**
	 * UI/UX 관련 로직을 관리하는 모듈 객체
	 */
	const StdHomeUI = {
		// 상태 관리 (현재 달란트 등)
		data: {
			currentTalent: 2500
		},

		/**
		 * 초기화 함수
		 */
		init: function () {
			this.cacheDOM();
			this.bindEvents();
			this.render();
		},

		cacheDOM: function () {
			this.$talentDisplay = $('.sub-money, #user-level');
			this.$expBar = $('#exp-bar');
			this.$expText = $('#current-exp');
			this.$typingTarget = $('#typing-bible');
		},

		bindEvents: function () {
			// 필요 시 클릭 이벤트 등을 여기에 바인딩
		},

		render: function () {
			// 1. 초기 경험치 바 애니메이션
			this.animateExpBar();

			// 2. 말씀 타이핑 효과 시작
			const text = this.$typingTarget.data('text'); // HTML data-text 속성에서 가져옴
			this.typeWriter(this.$typingTarget, text);

			// 3. 테스트용: 0.5초 뒤 달란트 50 증가
			setTimeout(() => this.updateTalent(50), 500);
		},

		/**
		 * 달란트(재화) 카운팅 애니메이션
		 * 연속 호출 시에도 자연스럽게 이어지도록 개선
		 */
		updateTalent: function (amount) {
			// 논리적 합계 즉시 반영
			this.data.currentTalent += amount;
			const targetValue = this.data.currentTalent;

			// 현재 화면에 표시되고 있는 숫자 파싱 (애니메이션 중간값)
			// 쉼표(,) 제거 후 숫자로 변환, 없으면 0
			let currentValue = parseInt(this.$talentDisplay.first().text().replace(/,/g, '')) || 0;

			// 이전 애니메이션 멈추고 새로운 목표값으로 애니메이션 시작
			$({val: currentValue}).stop(true).animate({val: targetValue}, {
				duration: 800,
				easing: 'swing',
				step: function (now) {
					// 소수점 버림 및 콤마 포맷팅
					StdHomeUI.$talentDisplay.text(Math.floor(now).toLocaleString());
				},
				complete: function () {
					// 최종 값 보정
					StdHomeUI.$talentDisplay.text(targetValue.toLocaleString());
				}
			});
		},

		/**
		 * 경험치 바 애니메이션
		 * data-current, data-max 속성을 활용하여 유연하게 처리
		 */
		animateExpBar: function () {
			// HTML 태그에서 값 가져오기 (예: <span id="current-exp" data-current="60" data-max="100">)
			const current = this.$expText.data('current') || 60;
			const max = this.$expText.data('max') || 100;

			const percentage = Math.min((current / max) * 100, 100); // 100% 넘지 않도록 방지

			// CSS 초기화 후 애니메이션
			this.$expBar.css('width', '0%');
			setTimeout(() => {
				this.$expBar.css({
					'width': percentage + '%',
					'transition': 'width 1s ease-out' // CSS transition 활용 (더 부드러움)
				});
			}, 100);
		},

		/**
		 * 타이핑 효과 (재사용 가능한 함수)
		 * @param {jQuery} $element - 대상 요소
		 * @param {String} text - 타이핑할 텍스트
		 * @param {Number} speed - 속도 (ms)
		 */
		typeWriter: function ($element, text, speed = 100) {
			if (!text) return;

			$element.text(''); // 초기화
			let i = 0;

			function typing() {
				if (i < text.length) {
					// append 대신 text를 누적하여 설정 (HTML 태그가 포함된 경우 html() 사용 고려)
					$element.text(text.substring(0, i + 1));
					i++;
					setTimeout(typing, speed);
				}
			}

			typing();
		}
	};

	// 실행
	$(function () {
		StdHomeUI.init();
	});
</script>
<div class="page active" layout:fragment="content">
	<div class="profile-card">
		<div style="display: flex; align-items: center; margin-bottom: 20px;">
			<div class="profile-avatar-wrap">
				<img src="https://cdn.jsdelivr.net/gh/ysrim/bjcc_ss@main/images/avatar/warrior.png"
				     id="user-profile-img" alt="내 캐릭터"
				     style="width:100%; height:100%; object-fit:cover; border-radius:18px;">
			</div>
			<div style="margin-left: 15px;">
				<div style="display: flex; gap: 5px;">
					<span class="user-rank-badge" style="background: #E3F2FD; color: #4A90E2;" id="user-grade-display">XXX 길드</span>
					<span class="user-rank-badge" style="background: #FFF3E0; color: #EF6C00;"><span id="user-level">2,500</span> 달란트</span>
				</div>
				<h2 id="user-display-name" style="font-size: 1.3rem; color: #333;">신입 용사님</h2>
			</div>
		</div>
		<div style="background: #FAFBFC; padding: 12px; border-radius: 15px;">
			<div style="display: flex; justify-content: space-between; font-size: 0.75rem; font-weight: bold; color: #777;">
				<span>성장 경험치 (EXP)</span>
				<span><span id="current-exp">60</span> / 100</span>
			</div>
			<div class="exp-container">
				<div id="exp-bar" class="exp-bar-fill" style="width: 60%;"></div>
			</div>
		</div>
	</div>
	<div class="card">
		<h4>오늘의 말씀 📖</h4>
		<p style="font-style:italic; min-height: 1.6em;">
			<span id="typing-bible">내게 능력 주시는 자 안에서 내가 모든 것을 할 수 있느니라</span>
		</p>
	</div>
	<div class="guild-section">
		<div class="guild-header">
			<div class="guild-name">
				<h4 style="color: #4A90E2;">🛡️ 다윗의 용사들</h4>
				<span class="guild-tag">LV.5</span>
			</div>
			<span style="font-size: 0.75rem; color: #666; font-weight: bold;">길드원 12/20</span>
		</div>
		<div style="margin-top: 10px;">
			<p style="font-size: 0.8rem; color: #666;">공동 퀘스트: 이번 주 말씀 50번 읽기</p>
			<div style="width: 100%; height: 6px; background: #eee; border-radius: 10px; margin-top: 5px;">
				<div style="width: 75%; height: 100%; background: #4A90E2; border-radius: 10px;"></div>
			</div>
			<p style="text-align: right; font-size: 0.7rem; color: #999; margin-top: 3px;">75% 달성 중</p>
		</div>
		<div class="guild-member-list">
			<div class="member-item">
				<img src="https://cdn.jsdelivr.net/gh/ysrim/bjcc_ss@main/images/avatar/warrior.png"
				     class="member-avatar">
				<div class="member-info">
					<div class="member-name">김용사 (나) <span class="master-badge">MASTER</span></div>
					<div class="member-status">오늘도 퀘스트 완료! 🔥</div>
				</div>
				<div style="text-align: right;">
					<div style="font-size: 0.8rem; font-weight: bold; color: #4A90E2;">Lv.15</div>
				</div>
			</div>

			<div class="member-item" style="opacity: 0.8;">
				<img src="https://cdn.jsdelivr.net/gh/ysrim/bjcc_ss@main/images/avatar/wizard.png"
				     class="member-avatar">
				<div class="member-info">
					<div class="member-name">이마법</div>
					<div class="member-status">접속 중</div>
				</div>
				<div style="text-align: right;">
					<div style="font-size: 0.8rem; font-weight: bold; color: #4A90E2;">Lv.12</div>
				</div>
			</div>
			<button style="width: 100%; padding: 10px; border: 1px dashed #DDD; background: none; border-radius: 15px; color: #999; font-size: 0.8rem; cursor: pointer;">
				+ 길드원 더보기
			</button>
		</div>
	</div>
	<div class="card" style="margin-top:15px;">
		<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
			<h4 style="margin: 0;">공지사항 📢</h4>
			<span style="font-size: 0.7rem; color: var(--gray); cursor: pointer;"
			      onclick="showPage('page-notice-detail')">전체보기 ></span>
		</div>
		<div class="notice-list">
			<div class="notice-item" onclick="showPage('page-notice-detail')"
			     style="padding: 12px 0; border-bottom: 1px solid #f0f0f0; cursor: pointer;">
				<div style="display: flex; gap: 8px; align-items: center; margin-bottom: 4px;">
					<span style="background: #FFEBEB; color: #FF4D4D; font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: bold;">중요</span>
					<span style="font-size: 0.9rem; font-weight: 700; color: #333;">이번 주 주일 야외 활동 안내</span>
				</div>
				<p style="font-size: 0.8rem; color: #777; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
					교회 근처 공원에서 보물찾기가 진행됩니다!</p>
			</div>
			<div class="notice-item" onclick="showPage('page-notice-detail')"
			     style="padding: 12px 0; border-bottom: 1px solid #f0f0f0; cursor: pointer;">
				<div style="display: flex; gap: 8px; align-items: center; margin-bottom: 4px;">
					<span style="background: #E3F2FD; color: #2196F3; font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: bold;">안내</span>
					<span style="font-size: 0.9rem; font-weight: 700; color: #333;">새 친구 환영 파티 (다음 주)</span>
				</div>
				<p style="font-size: 0.8rem; color: #777; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
					새로 온 친구들을 위해 맛있는 간식이 준비되어 있어요.</p>
			</div>
			<div class="notice-item" onclick="showPage('page-notice-detail')" style="padding: 12px 0; cursor: pointer;">
				<div style="display: flex; gap: 8px; align-items: center; margin-bottom: 4px;">
					<span style="background: #F5F5F5; color: #666; font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: bold;">필독</span>
					<span style="font-size: 0.9rem; font-weight: 700; color: #333;">달란트 시장 개최 공지</span>
				</div>
				<p style="font-size: 0.8rem; color: #777; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
					열심히 모은 달란트를 사용할 시간이 왔습니다!</p>
			</div>
		</div>
	</div>
</div>
</html>