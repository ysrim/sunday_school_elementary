<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/app/psn/mng/layouts/mng_layout}" lang="ko">
<th:block layout:fragment="content">
	<script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>

	<div id="page-members" class="page-content w-full min-h-screen bg-[#f8f9fa] p-5 font-sans text-slate-600 animate-fade-in">

		<div id="view-list" class="flex flex-col h-full">
			<header class="flex justify-between items-end mb-6">
				<div>
					<span class="px-2.5 py-0.5 rounded-full bg-indigo-50 text-indigo-600 text-[10px] font-bold uppercase tracking-wider mb-1 inline-block">Management</span>
					<h1 class="text-2xl font-black text-slate-900 tracking-tight">Kingdom Warriors</h1>
					<p class="text-xs text-slate-500 mt-1 font-medium">왕국에 소속된 용사들의 정보를 관리합니다.</p>
				</div>
				<button onclick="MemberManager.ui.toggleMode('write')"
				        class="bg-indigo-600 text-white px-4 py-2.5 rounded-xl text-xs font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition flex items-center transform hover:scale-105 active:scale-95">
					<i class="fas fa-user-plus mr-2"></i> 신규 용사 등록
				</button>
			</header>

			<div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 mb-5 flex flex-wrap gap-3 justify-between items-center">
				<div class="relative w-full md:w-64 group">
					<input type="text" id="gridSearchInput" placeholder="이름 또는 ID 검색"
					       class="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-xl text-xs font-bold focus:ring-2 focus:ring-indigo-100 focus:border-indigo-500 outline-none transition group-hover:bg-white">
					<i class="fas fa-search absolute left-3.5 top-2.5 text-slate-400 text-xs group-hover:text-indigo-500 transition-colors"></i>
				</div>
			</div>

			<div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
				<div id="memberGrid" class="ag-theme-quartz" style="width: 100%; height: 600px;"></div>
			</div>
		</div>

		<div id="view-write" class="hidden animate-fade-in">
			<header class="flex justify-between items-center mb-6">
				<div class="flex items-center gap-3">
					<button onclick="MemberManager.ui.toggleMode('list')"
					        class="w-8 h-8 rounded-full bg-white border border-slate-200 text-slate-500 flex items-center justify-center hover:bg-slate-50 hover:text-slate-800 transition shadow-sm">
						<i class="fas fa-arrow-left text-xs"></i>
					</button>
					<h1 id="form-title" class="text-xl font-black text-slate-900 tracking-tight">신규 용사 등록</h1>
				</div>
				<div class="flex gap-2">
					<button onclick="MemberManager.ui.toggleMode('list')"
					        class="px-4 py-2 rounded-xl bg-white border border-slate-200 text-slate-600 text-xs font-bold hover:bg-slate-50 transition shadow-sm">
						취소
					</button>
					<button onclick="MemberManager.api.saveMember()" class="px-4 py-2 rounded-xl bg-indigo-600 text-white text-xs font-bold hover:bg-indigo-700 shadow-md shadow-indigo-200 transition flex items-center">
						<i class="fas fa-check mr-1.5"></i> 저장하기
					</button>
				</div>
			</header>

			<form id="memberForm">
				<input type="hidden" id="mberSn" name="mberSn">
				<div class="grid grid-cols-1 lg:grid-cols-3 gap-5">
					<div class="lg:col-span-1">
						<div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm text-center">
							<div class="relative inline-block mb-4 group cursor-pointer">
								<img id="formAvatar" src="https://api.dicebear.com/7.x/avataaars/svg?seed=New"
								     class="w-24 h-24 rounded-2xl bg-slate-50 border-2 border-slate-100 group-hover:border-indigo-300 transition-colors">
								<div class="absolute bottom-0 right-0 bg-indigo-600 w-8 h-8 rounded-full text-white flex items-center justify-center border-2 border-white shadow-md group-hover:scale-110 transition-transform">
									<i class="fas fa-camera text-xs"></i>
								</div>
							</div>
							<h3 class="font-bold text-slate-800">프로필 이미지</h3>
							<p class="text-[10px] text-slate-400 mt-1">클릭하여 아바타를 변경하세요.</p>
							<div class="mt-6 pt-6 border-t border-slate-100 text-left space-y-3">
								<div>
									<label class="form-label">초기 레벨 설정</label>
									<div class="flex items-center gap-2">
										<input type="number" id="formLevel" value="1" class="form-input text-center font-black text-indigo-600 !w-20">
										<span class="text-xs font-bold text-slate-400">LV</span>
									</div>
								</div>
							</div>
						</div>
					</div>
					<div class="lg:col-span-2">
						<div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm space-y-5">
							<div class="grid grid-cols-1 md:grid-cols-2 gap-5">
								<div><label class="form-label">이름 *</label><input type="text" id="formName" class="form-input"></div>
								<div><label class="form-label">아이디 *</label><input type="text" id="formId" class="form-input"></div>
								<div>
									<label class="form-label">학년 / 반 *</label>
									<div class="flex gap-2">
										<select id="formGrade" class="form-input">
											<option value="1">1학년</option>
											<option value="2">2학년</option>
											<option value="3">3학년</option>
										</select>
										<select id="formClass" class="form-input">
											<option value="믿음">믿음반</option>
											<option value="소망">소망반</option>
											<option value="사랑">사랑반</option>
										</select>
									</div>
								</div>
								<div>
									<label class="form-label">직업 *</label>
									<select id="formJob" class="form-input">
										<option value="WARRIOR">전사</option>
										<option value="MAGE">마법사</option>
										<option value="ARCHER">궁수</option>
										<option value="ROGUE">도적</option>
									</select>
								</div>
							</div>
							<div class="grid grid-cols-1 md:grid-cols-2 gap-5">
								<div><label class="form-label">연락처</label><input type="tel" id="formPhone" class="form-input"></div>
								<div><label class="form-label">보호자 연락처</label><input type="tel" id="formParentPhone" class="form-input"></div>
								<div class="md:col-span-2"><label class="form-label">메모</label><textarea id="formMemo" rows="3" class="form-input"></textarea></div>
							</div>
						</div>
					</div>
				</div>
			</form>
		</div>
	</div>

	<script th:inline="javascript">
		/*<![CDATA[*/

		const MemberManager = {
			gridApi: null,

			init() {
				this.grid.init();
				this.bindEvents();
				this.grid.loadData();
			},

			grid: {
				init() {
					const columnDefs = [
						{
							headerName: "용사 정보", field: "name", width: 220, // 성명 영역 조금 확장
							cellClass: "flex items-center",
							cellRenderer: (params) => {
								return `
					                  <div class="flex items-center gap-3 w-full">
					                     <div class="relative w-11 h-11 flex-shrink-0">
					                        <img src="${params.data.avatar}" class="w-full h-full rounded-xl bg-slate-100 border border-slate-200 object-cover">
					                     </div>
					                     <div class="flex flex-col justify-center">
					                        <div class="font-bold text-slate-800 text-sm leading-tight">${params.value}</div>
					                        <div class="text-[10px] text-slate-400 font-medium leading-tight mt-1">@${params.data.userId}</div>
					                     </div>
					                  </div>
					               `;
							}
						},
						{
							headerName: "직업", field: "jobName", width: 100,
							cellClass: "flex items-center justify-center font-bold text-slate-600 text-xs",
						},
						{
							headerName: "소속 (학년/반/길드)", width: 180,
							cellClass: "flex items-center",
							cellRenderer: (params) => {
								return `
					                  <div class="text-xs text-slate-700">
					                     <span class="font-bold">${params.data.grade}학년 ${params.data.classNm}반</span><br/>
					                     <span class="text-indigo-600 font-bold">${params.data.guildName}</span>
					                  </div>
					               `;
							}
						},
						{
							headerName: "성장 지표 (LV / EXP)",
							field: "level",
							flex: 1,
							minWidth: 300,
							cellRenderer: (params) => {
								// 데이터가 없거나 0일 경우를 대비한 안전 장치
								const exp = params.data.exp || 0;
								const maxExp = params.data.maxExp || 1; // 0으로 나누기 방지
								const percent = Math.min((exp / maxExp) * 100, 100);

								return `
							            <div style="display: flex; align-items: center; width: 100%; height: 100%;">
							                <span style="font-weight: 900; color: #4f46e5; font-style: italic; font-size: 14px; width: 50px; text-align: right; margin-right: 12px;">
							                    LV.${params.value}
							                </span>

							                <div style="flex: 1; height: 10px; background-color: #f1f5f9; border: 1px solid #e2e8f0; border-radius: 10px; overflow: hidden; position: relative;">
							                    <div style="width: ${percent}%; height: 100%; background: linear-gradient(90deg, #6366f1, #a855f7, #ec4899); border-radius: 10px;"></div>
							                </div>

							                <span style="font-size: 11px; color: #64748b; font-weight: bold; width: 110px; text-align: right; margin-left: 12px;">
							                    ${exp.toLocaleString()} / ${maxExp.toLocaleString()}
							                </span>
							            </div>
							        `;
							}
						},
						{
							headerName: "달란트", field: "gold", width: 120,
							cellClass: "flex items-center",
							cellRenderer: (params) => {
								return `
					                  <div class="flex items-center text-amber-600 font-bold bg-amber-50 px-2 py-1 rounded-lg border border-amber-100 text-xs">
					                     <i class="fas fa-coins mr-1.5 text-amber-500"></i> ${params.value.toLocaleString()}
					                  </div>
					               `;
							}
						}
					];

					const gridOptions = {
						columnDefs: columnDefs,
						rowData: [],
						defaultColDef: {resizable: true, sortable: true},
						pagination: true,
						paginationPageSize: 20,
						headerHeight: 48,
						rowHeight: 80, // 행 높이를 늘려 시인성 확보
						rowClass: "hover:bg-indigo-50/30 transition-colors cursor-pointer",
						overlayLoadingTemplate: `<div class="flex flex-col items-center"><i class="fas fa-spinner fa-spin text-2xl text-indigo-500 mb-2"></i><span class="text-xs text-slate-500 font-bold">용사 정보를 불러오는 중...</span></div>`,
						overlayNoRowsTemplate: `<div class="text-xs text-slate-400 py-10">등록된 용사가 없습니다.</div>`,
						onRowClicked: (event) => {
							if (!event.event.target.closest('button')) {
								MemberManager.ui.editMember(event.data.id);
							}
						}
					};

					const gridDiv = document.querySelector('#memberGrid');
					MemberManager.gridApi = agGrid.createGrid(gridDiv, gridOptions);
				},

				loadData() {
					const api = MemberManager.gridApi;
					if (!api) return;

					api.showLoadingOverlay();

					// 서버 API 호출
					$.ajax({
						url: '/mng/mber/getMberList.ax',
						type: 'POST',
						dataType: 'json',
						success: function (response) {
							const mappedData = response.rtnData.map(item => {
								const genderKey = item.sexdstn ? item.sexdstn.toLowerCase() : 'M';
								return {
									id: item.mberSn,
									name: item.mberNm,
									userId: item.mberId,
									job: item.occpCode,
									jobName: item.occpNm,
									grade: item.grade,
									classNm: item.cla,
									guildName: item.guildNm || '소속 없음',
									level: item.level,
									exp: item.currExp,
									maxExp: item.maxExp,
									gold: item.point,
									phone: '',
									avatar: `https://cdn.jsdelivr.net/gh/ysrim/bjcc_ss@main/images/avatar/${item.occpCode}_${genderKey}.png`,
									online: true
								};
							});

							api.updateGridOptions({rowData: mappedData});
							api.hideOverlay();
						},
						error: function (xhr, status, error) {
							console.error("데이터 로드 실패:", error);
							api.updateGridOptions({rowData: []});
						}
					});
				}
			},

			// --- 2. Event Listeners ---
			bindEvents() {
				$('#gridSearchInput').on('input', function () {
					if (MemberManager.gridApi) MemberManager.gridApi.setGridOption('quickFilterText', $(this).val());
				});
			},

			// --- 3. UI Control ---
			ui: {
				toggleMode(mode) {
					const listDiv = $('#view-list');
					const writeDiv = $('#view-write');
					const title = $('#form-title');

					if (mode === 'write') {
						$('#memberForm')[0].reset();
						$('#formAvatar').attr('src', 'https://api.dicebear.com/7.x/avataaars/svg?seed=New');
						$('#mberSn').val('');
						title.text('신규 용사 등록');
						listDiv.addClass('hidden');
						writeDiv.removeClass('hidden');
					} else if (mode === 'list') {
						writeDiv.addClass('hidden');
						listDiv.removeClass('hidden');
					}
				},

				editMember(id) {
					const listDiv = $('#view-list');
					const writeDiv = $('#view-write');
					const title = $('#form-title');

					let rowData = null;
					MemberManager.gridApi.forEachNode(node => {
						if (node.data.id === id) rowData = node.data;
					});

					if (rowData) {
						$('#mberSn').val(rowData.id);
						$('#formName').val(rowData.name);
						$('#formId').val(rowData.userId);
						$('#formGrade').val(rowData.grade);
						title.text('용사 정보 수정');
						listDiv.addClass('hidden');
						writeDiv.removeClass('hidden');
					}
				}
			},

			// --- 4. API Actions ---
			api: {
				saveMember() {
					alert('준비중..');
					/*
					const formData = {
						name: $('#formName').val(),
					};
					if (!formData.name) return alert('이름을 입력해주세요.');
					alert('저장되었습니다.');
					MemberManager.ui.toggleMode('list');
					MemberManager.grid.loadData();
					*/
				},

				deleteMember(id) {
					alert('준비중..');
					/*
					if (confirm('정말 이 용사를 추방(삭제)하시겠습니까?')) {
						alert('삭제되었습니다.');
						MemberManager.grid.loadData();
					}
					*/
				}
			}
		};

		$(function () {
			MemberManager.init();
		});
		/*]]>*/
	</script>
</th:block>
</html>