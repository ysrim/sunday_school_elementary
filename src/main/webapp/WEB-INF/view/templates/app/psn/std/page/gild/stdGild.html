<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/app/psn/std/layouts/std_layout}">
<th:block layout:fragment="content">

	<div class="guild-header-bar">
		<div class="guild-header-line"></div>
		<h3 class="guild-header-title">ê¸¸ë“œ ì •ë³´</h3>
	</div>

	<div class="guild-banner-card">
		<div class="guild-badge-wrapper">
			<div class="guild-badge-icon">
				<img th:src="|https://cdn.jsdelivr.net/gh/ysrim/bjcc_ss@main/images/guild/grade/guid_image_${gildInfo.grade}_${gildInfo.cla}.png|"
				     alt="ê¸¸ë“œë§ˆí¬">
			</div>
			<div class="guild-lvl-badge" th:text="|LV. ${gildInfo.guildLevel}|">LV. 5</div>
		</div>

		<h2 class="guild-main-name" style="margin: 5px 0;" th:text="|${gildInfo.guildNm}|">ë‹¤ìœ—ì˜ ìš©ì‚¬ë“¤</h2>
		<p style="opacity: 0.8; font-style: italic; margin-bottom: 20px;" th:text="|&quot;${gildInfo.rm}&quot;|">"ë‘ë ¤ì›Œ
			ë§ê³  ë¯¿ìŒìœ¼ë¡œ ë‚˜ì•„ê°€ì!"</p>

		<div class="flex-row"
		     style="justify-content: space-around; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 15px;">
			<div class="guild-stat-box">
				<span style="font-size: 0.7rem; opacity: 0.6;">ê¸¸ë“œì›</span>
				<span style="font-weight: bold;" th:text="|${gildMberAccessList.size()}/${gildMberCnt}|">12/20</span>
			</div>
			<div class="guild-stat-box"><span style="font-size: 0.7rem; opacity: 0.6;">ë­í‚¹</span><span
					style="font-weight: bold;">-</span></div>
			<div class="guild-stat-box"><span style="font-size: 0.7rem; opacity: 0.6;">í¬ì¸íŠ¸</span><span
					style="font-weight: bold;">-</span></div>
		</div>
	</div>

	<div class="section-title">ğŸ’¬ ê¸¸ë“œì› ì‘ì›ë°©</div>
	<div class="card" style="border-radius: 20px; padding: 15px;">

		<div id="guild-chat-list">
			<div id="chat-loading" class="chat-loading-overlay" style="display: none;">
				<div class="chat-spinner"></div>
			</div>

			<div id="empty-msg" class="empty-chat-placeholder" style="display: none;">
				<img src="https://cdn-icons-png.flaticon.com/512/1380/1380338.png" alt="empty"
				     style="width: 50px; opacity: 0.5; margin-bottom: 10px;">
				<p style="color: #999; font-size: 0.9rem;">ì•„ì§ ì‘ì› ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.<br>ì²« ë²ˆì§¸ ì‘ì›ì„ ë‚¨ê²¨ë³´ì„¸ìš”!</p>
			</div>
		</div>

		<div class="flex-row gap-5">
			<input type="text" id="guild-chat-input" placeholder="ì‘ì› ë©”ì‹œì§€ë¥¼ ë‚¨ê²¨ë³´ì„¸ìš”!"
			       style="border-radius: 25px; padding-left: 20px; flex: 1; border: 1px solid #ddd; height: 42px;"
			       autocomplete="off">
			<button id="btn-send" type="button"
			        style="background: #4A90E2; color: white; border: none; border-radius: 25px; padding: 0 20px; font-weight: bold; height: 42px; min-width: 80px; display: flex; align-items: center; justify-content: center;">
				<span class="btn-text">ì „ì†¡</span>
				<div class="btn-spinner" style="display: none;"></div>
			</button>
		</div>
	</div>

	<div class="section-title">
		<span>ğŸ‘¥ ê¸¸ë“œì› ëª©ë¡</span>
		<span class="text-light" style="font-weight: normal; font-size: 0.8rem; margin-left: auto;"
		      th:text="|ì´ ${gildMberCnt}ëª…|">ì´ 12ëª…</span>
	</div>

	<div class="card" style="padding: 5px 15px;">
		<div class="flex-row"
		     style="padding: 10px 5px; border-bottom: 2px solid #f5f5f5; font-size: 0.75rem; color: #999; font-weight: bold;">
			<span style="flex: 1; padding-left: 5px;">ì´ë¦„ / ì§ì—…</span>
			<span style="width: 120px; text-align: right;">Lv / ë‹¬ë€íŠ¸</span>
		</div>

		<div style="max-height: 300px; overflow-y: auto; scroll-behavior: smooth;">
			<div class="member-row" style="border:none; border-bottom:1px dashed #eee; border-radius:0;"
			     th:each="vo : ${gildMberAccessList}">
				<img th:src="|https://cdn.jsdelivr.net/gh/ysrim/bjcc_ss@main/images/avatar/${vo.occpCode}_${#strings.toLowerCase(vo.sexdstn)}.png|"
				     class="member-avatar">

				<div class="flex-col flex-1">
                <span class="text-bold" style="font-size: 0.9rem;">
                    [[${vo.ncnm}]]
                    <span th:if="${vo.mberId == session.mberInfo.mberId}"
                          style="color: #4A90E2; font-size: 0.8em;">(ë‚˜)</span>
                </span>
					<span class="text-light" style="font-size: 0.75rem;" th:if="${vo.isAccess}">
                   <span class="status-dot online"
                         style="background-color: #4CAF50; width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 3px;"></span>ì ‘ì† ì¤‘
                </span>
				</div>

				<div class="text-right" style="font-size: 0.85rem;">
					<span class="text-bold text-sub text-blue" th:text="|Lv.${vo.level} ${vo.occpNm}|">Lv.14</span>
					<span style="color: #ccc; margin: 0 4px;">/</span>
					<span class="text-sub text-bold" th:text="|${vo.point} P|">2,500 P</span>
				</div>
			</div>
		</div>
	</div>

	<script th:inline="javascript">
		/*<![CDATA[*/
		// ìƒìˆ˜ ë° ìºì‹œ
		const API = {
			LIST: '/std/gild/getGildPost.ax',
			REG: '/std/gild/regGildPost.ax',
			DEL: '/std/gild/delGildPost.ax'
		};

		let $els = {}; // DOM ìš”ì†Œ ê·¸ë£¹í™”

		$(function () { // $(document).ready ë‹¨ì¶•
			// DOM ìºì‹±
			$els = {
				chatList: $('#guild-chat-list'),
				emptyMsg: $('#empty-msg'),
				input: $('#guild-chat-input'),
				btnSend: $('#btn-send'),
				loading: $('#chat-loading')
			};

			loadChats();
			initEvents();
		});

		function initEvents() {
			$els.btnSend.on('click', sendChat);

			$els.input.on('keypress', e => {
				if (e.which === 13) {
					sendChat();
					return false;
				}
			});

			// ì´ë²¤íŠ¸ ìœ„ì„ (ë™ì  ìš”ì†Œ ì²˜ë¦¬)
			$els.chatList.on('click', '.chat-delete-btn', function () {
				deleteChat($(this).data('sn'), $(this));
			});
		}

		// ì±„íŒ… ëª©ë¡ ë¡œë“œ
		function loadChats() {
			$els.loading.fadeIn(200);

			$.ajax({
				url: API.LIST,
				type: 'GET',
				dataType: 'json',
			})
				.done(res => { // Promise íŒ¨í„´ (.done, .fail, .always) ì‚¬ìš©
					const list = res.rtnData || [];

					// ê¸°ì¡´ ì±„íŒ…ë§Œ ì œê±° (ë¡œë”©ë°”, ë¹ˆ ë©”ì‹œì§€ ìœ ì§€)
					$els.chatList.children().not('#empty-msg, #chat-loading').remove();

					if (list.length === 0) {
						$els.emptyMsg.css('display', 'flex');
					} else {
						$els.emptyMsg.hide();

						// DocumentFragment ì‚¬ìš©ìœ¼ë¡œ ë Œë”ë§ ì„±ëŠ¥ ìµœì í™”
						const fragment = document.createDocumentFragment();
						list.forEach(chat => {
							const isMine = (chat.isMine === 'Y');
							fragment.appendChild(createChatEl(chat, isMine));
						});

						$els.chatList.append(fragment);
						scrollBottom();
					}
				})
				.fail(xhr => console.error("Load failed:", xhr))
				.always(() => setTimeout(() => $els.loading.fadeOut(200), 300));
		}

		// ì±„íŒ… DOM ìƒì„±
		function createChatEl(data, isMine) {
			const avatar = `https://cdn.jsdelivr.net/gh/ysrim/bjcc_ss@main/images/avatar/${data.occpCode}_${data.sexdstn}.png`;
			const delBtn = isMine ? `<button class="chat-delete-btn" data-sn="${data.postSn}">ì‚­ì œ</button>` : '';

			const div = document.createElement('div');
			div.className = `chat-row ${isMine ? 'my-chat' : ''}`;
			div.innerHTML = `
               <img src="${avatar}" class="chat-avatar">
               <div class="chat-content-box">
                   <span class="chat-name">${data.mberNm}</span>
                   <div class="chat-bubble">${data.content}</div>
                   ${delBtn}
               </div>
            `;
			return div;
		}

		// ë©”ì‹œì§€ ì „ì†¡
		function sendChat() {
			const msg = $els.input.val().trim();
			if (!msg) {
				_showAlert('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'âš ï¸');
				return $els.input.focus();
			}
			if ($els.btnSend.prop('disabled')) return;

			toggleLoading(true);

			$.ajax({
				url: API.REG,
				type: 'POST',
				data: {content: msg}
			})
				.done(() => {
					loadChats();
					$els.input.val('');
					_showAlert('ê³µìœ  ì™„ë£Œ! ğŸš€');
				})
				.fail(() => _showAlert('ì „ì†¡ ì‹¤íŒ¨ âŒ'))
				.always(() => {
					setTimeout(() => {
						toggleLoading(false);
						$els.input.focus();
					}, 300);
				});
		}

		// ë©”ì‹œì§€ ì‚­ì œ
		function deleteChat(sn, $btn) {
			if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

			$.ajax({
				url: API.DEL,
				type: 'POST',
				data: {postSn: sn}
			})
				.done(res => {
					if (res.rtnCd === '001') {
						$btn.closest('.chat-row').fadeOut(300, function () {
							$(this).remove();
							if ($els.chatList.children().not('#empty-msg, #chat-loading').length === 0) {
								$els.emptyMsg.fadeIn();
							}
						});
						_showAlert('ì‚­ì œ ì™„ë£Œ ğŸ—‘ï¸');
					} else {
						_showAlert(`ì‚­ì œ ì‹¤íŒ¨ (ì½”ë“œ: ${res.rtnCd}) âŒ`);
					}
				})
				.fail(() => _showAlert('ì„œë²„ ì˜¤ë¥˜ âŒ'));
		}

		// UI ìœ í‹¸ë¦¬í‹°
		function toggleLoading(state) {
			$els.btnSend.prop('disabled', state).toggleClass('loading', state);
			$els.input.prop('disabled', state);

			const $txt = $els.btnSend.find('.btn-text');
			const $spin = $els.btnSend.find('.btn-spinner');
			state ? ($txt.hide(), $spin.show()) : ($txt.show(), $spin.hide());
		}

		function scrollBottom() {
			setTimeout(() => $els.chatList.scrollTop($els.chatList[0].scrollHeight), 50);
		}

		/*]]>*/
	</script>
</th:block>
</html>