<!DOCTYPE html>
<html xmlns:th="http//www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/app/psn/tch/layouts/tch_layout}" lang="ko">
<th:block layout:fragment="content">
	<section id="tab-home" class="section-content active">
		<div class="mb-6 px-1">
			<h2 class="text-2xl font-extrabold text-slate-900 flex items-center gap-2">
				[[${session.tchMberInfo.guildNm}]]ê¸¸ë“œ ëª¨í—˜ ë¸Œë¦¬í•‘
				<span class="text-[11px] font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded-lg border border-blue-100"
				      th:text="${dashboard.weekName}">1ì›” 4ì£¼</span>
			</h2>
			<p class="text-sm text-slate-400 mt-1">ì˜¤ëŠ˜ì˜ ì™•êµ­ í™œë™ í˜„í™©ì„ í™•ì¸í•˜ì„¸ìš”.</p>
		</div>
		<div class="card-box p-7 bg-gradient-to-br from-blue-600 to-indigo-600 text-white border-0 shadow-lg relative">
			<div class="flex justify-between items-center mb-6 relative z-10">
				<div>
					<div class="text-blue-100 text-xs font-bold mb-1 opacity-80"
					     th:text="|ì¶œì„í˜„í™© ${dashboard.monthName}|">ì¶œì„í˜„í™©(02.01)
					</div>
					<div class="text-4xl font-black">[[${dashboard.atndCnt}]] <span
							class="text-lg opacity-70 font-medium" th:text="|/ ${dashboard.gildCnt}ëª…|">/ 21ëª…</span>
					</div>
				</div>
				<div class="text-right">
					<div class="text-blue-100 text-xs font-bold mb-1 opacity-80">ëˆ„ì  ë‹¬ë€íŠ¸</div>
					<div class="text-2xl font-black">[[${#numbers.formatInteger(dashboard.sumPoint, 1, 'COMMA')}]] <span
							class="text-sm opacity-70">P</span></div>
				</div>
			</div>
			<div class="grid grid-cols-4 gap-2 text-center border-t border-white/20 pt-6 relative z-10">
				<div>
					<div class="text-[10px] opacity-80 mb-1">ëŒ€ê¸°</div>
					<div class="font-bold text-yellow-300" th:text="|${dashboard.pendingCnt}ê±´|">3</div>
				</div>
				<div class="border-l border-white/20">
					<div class="text-[10px] opacity-80 mb-1">ì¶œì„ë¥ </div>
					<div class="font-bold" th:text="|${dashboard.atndPct}%|">85%</div>
				</div>
				<div class="border-l border-white/20">
					<div class="text-[10px] opacity-80 mb-1">ëˆ„ì </div>
					<div class="font-bold" th:text="|${dashboard.totalAtndPct}%|">85%</div>
				</div>
				<div class="border-l border-white/20">
					<div class="text-[10px] opacity-80 mb-1">ì¥ê²°</div>
					<div class="font-bold text-red-300" th:text="|${dashboard.longAbsenceCnt}ëª…|">85%</div>
				</div>
			</div>
			<div class="absolute -right-10 -bottom-10 w-40 h-40 bg-white/10 rounded-full blur-3xl"></div>
		</div>

		<div class="mt-6">
			<h3 class="font-bold text-slate-800 mb-3 px-1 flex items-center">
				<i class="fas fa-bullhorn text-blue-500 mr-2"></i>ì˜¤ëŠ˜ì˜ ë©”ì‹œì§€
			</h3>
			<div class="card-box p-5">
				<div id="banner-preview"
				     class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-2xl p-4 mb-4 text-white shadow-md relative overflow-hidden transition-all duration-300">
					<div class="flex items-center gap-3 relative z-10">
						<div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
							<i class="fas fa-comment-dots"></i>
						</div>
						<p id="preview-text" class="flex-1 text-sm font-bold leading-snug" th:text="|${gildMsg}|">
							ì˜¤ëŠ˜ì˜ ê³µì§€ì‚¬í•­ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.
						</p>
					</div>
				</div>

				<div class="flex gap-2 items-start">
					<div class="flex-1 relative">
                <textarea id="message-input" rows="2" placeholder="ë©”ì‹œì§€ ì…ë ¥... (ìµœëŒ€ 400byte)"
                          onkeyup="checkByteLimit(this, 400)"
                          class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-100 resize-none transition-colors"></textarea>
						<div class="text-right px-1 mt-1">
							<span id="text-byte" class="text-[10px] text-blue-600 font-bold">0</span>
							<span class="text-[10px] text-slate-400">/ 400 byte</span>
						</div>
					</div>
					<button id="btn-save-msg" onclick="saveTodayMessage()"
					        class="w-14 h-[54px] bg-blue-600 text-white rounded-xl flex flex-col items-center justify-center shadow-md active:scale-95 transition hover:bg-blue-700 disabled:bg-slate-300 disabled:cursor-not-allowed">
						<i class="fas fa-paper-plane text-sm mb-0.5"></i>
						<span class="text-[10px] font-bold">ê²Œì‹œ</span>
					</button>
				</div>
			</div>
		</div>

		<div class="mt-8">
			<div class="flex justify-between items-end mb-4 px-1">
				<div>
					<h3 class="font-black text-slate-800 text-lg flex items-center">
                <span class="w-8 h-8 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center mr-2 text-sm">
                    <i class="fas fa-comment-dots"></i>
                </span>
						ê¸¸ë“œ ë¼ìš´ì§€
					</h3>
				</div>
				<span class="text-[11px] font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded-md uppercase tracking-wider">Live Briefing</span>
			</div>

			<div class="card-box overflow-hidden border-0 shadow-xl rounded-3xl bg-white">
				<div id="comment-list" class="db-lounge-list custom-scrollbar">
				</div>

				<div class="p-4 bg-white border-t border-slate-50">
					<div class="bg-slate-50 rounded-2xl p-2 focus-within:ring-2 focus-within:ring-blue-100 transition-all">
                <textarea id="comment-input" rows="2"
                          placeholder="ê¸¸ë“œì›ë“¤ê³¼ ë”°ëœ»í•œ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ ë³´ì„¸ìš”..."
                          onkeyup="checkByteLimit(this, 400, 'comment-byte')"
                          class="w-full bg-transparent border-0 p-2 text-sm focus:outline-none resize-none placeholder:text-slate-400"></textarea>

						<div class="flex justify-between items-center mt-1 px-1">
							<div class="dbl-byte-wrapper">
								<span id="comment-byte" class="dbl-byte-text">0</span>
								<span class="dbl-byte-max">/ 400 byte</span>
							</div>

							<button id="btn-reg-post" onclick="postComment()"
							        class="group bg-slate-900 hover:bg-indigo-600 text-white px-5 py-2 rounded-xl flex items-center gap-2 transition-all active:scale-95 shadow-lg shadow-slate-200">
								<span class="text-xs font-bold">ê²Œì‹œí•˜ê¸°</span>
								<i class="fas fa-paper-plane text-[10px] group-hover:translate-x-1 group-hover:-translate-y-1 transition-transform"></i>
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</section>
	<script th:inline="javascript">

        function saveTodayMessage() {
            const $input = $('#message-input');
            const $preview = $('#preview-text');
            const $btn = $('#btn-save-msg');
            const $btnIcon = $btn.find('i');
            const $btnText = $btn.find('span');
            const message = $input.val().trim();
            // 1. ìœ íš¨ì„± ê²€ì‚¬
            if (!message) {
                _showToast("ë©”ì‹œì§€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”. âŒ");
                $input.focus();
                return;
            }
            // 2. ë¡œë”© UI ì‹œì‘
            const originalIconClass = "fas fa-paper-plane text-sm mb-0.5"; // ì›ë˜ ì•„ì´ì½˜ í´ë˜ìŠ¤
            $btn.prop('disabled', true);        // ë²„íŠ¼ ë¹„í™œì„±í™”
            $btnText.text('ì €ì¥ì¤‘');            // í…ìŠ¤íŠ¸ ë³€ê²½
            $btnIcon.attr('class', 'fas fa-circle-notch fa-spin text-lg mb-0.5'); // ìŠ¤í”¼ë„ˆ ì•„ì´ì½˜ìœ¼ë¡œ ë³€ê²½
            // 3. ì„œë²„ ì „ì†¡ (AJAX)
            $.ajax({
                url: '/tch/home/saveGildMsg.ax',
                type: 'POST',
                data: {slogan: message},
                success: function (response) {
                    $preview.fadeOut(200, function () { // ì„±ê³µ ì‹œ ë¯¸ë¦¬ë³´ê¸° í…ìŠ¤íŠ¸ ê°±ì‹  (ê¹œë¹¡ì„ íš¨ê³¼)
                        $(this).text(message).fadeIn(200);
                    });
                    $input.val(''); // ì…ë ¥ì°½ ì´ˆê¸°í™”
                    $('#text-byte').text('0'); // ì¹´ìš´í„° ì´ˆê¸°í™”
                    _showToast('ê¸¸ë“œ ë©”ì‹œì§€ë¥¼ ê°±ì‹ í–ˆìŠµë‹ˆë‹¤. âœ…');
                },
                error: function (xhr, status, error) {
                    console.error("ì €ì¥ ì‹¤íŒ¨:", error);
                    _showToast("ë©”ì‹œì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”. âŒ");
                },
                complete: function () {
                    setTimeout(function () { // 4. ë¡œë”© UI ì¢…ë£Œ (0.5ì´ˆ ë”œë ˆì´ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ)
                        $btn.prop('disabled', false);
                        $btnText.text('ê²Œì‹œ');
                        $btnIcon.attr('class', originalIconClass);
                    }, 500);
                }
            });
        }

        /**
         * ê³µí†µ Byte ì²´í¬ í•¨ìˆ˜ (ID ì¸ìë¥¼ ì¶”ê°€í•˜ì—¬ ì¬ì‚¬ìš© ê°€ëŠ¥í•˜ê²Œ ìˆ˜ì •)
         */
        function checkByteLimit(obj, maxByte, targetId) {
            const str = obj.value;
            let totalByte = 0;
            let len = 0;
            for (let i = 0; i < str.length; i++) {
                const c = str.charCodeAt(i);
                if (c > 128) totalByte += 2;
                else totalByte++;

                if (totalByte <= maxByte) len = i + 1;
            }

            $(`#${targetId}`).text(totalByte);

            if (totalByte > maxByte) {
                _showToast(`ìµœëŒ€ ${maxByte}Byteê¹Œì§€ë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
                obj.value = str.substr(0, len);
                $(`#${targetId}`).text(maxByte);
            }
        }

        function deleteComment(btn) {
            if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            const $target = $(btn).closest('.db-lounge-item');
            const postSn = $(btn).data('val');

            $.ajax({
                url: '/tch/home/delGildPost.ax',
                type: 'POST',
                data: {postSn: postSn},
                success: function () {
                    // ì‚­ì œ íš¨ê³¼ ì ìš©
                    $target.addClass('db-lounge-fade-out');
                    setTimeout(() => {
                        $target.remove();
                        checkEmptyLounge();
                        _showToast('ë©”ì‹œì§€ë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤. âœ…');
                    }, 500); // ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„ê³¼ ë§ì¶¤
                },
                error: function () {
                    _showToast("ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. âŒ");
                }
            });
        }

        // 1. ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° (Read)
        function loadLoungeList() {
            const $list = $('#comment-list');

            $list.html(`
       <div class="dbl-loader">
           <div class="dbl-spinner"></div>
           <p class="text-xs text-slate-400 font-medium">ë¼ìš´ì§€ ì†Œì‹ì„ ê°€ì ¸ì˜¤ëŠ” ì¤‘...</p>
       </div>
    `);

            $.ajax({
                url: '/tch/home/getGildPost.ax',
                type: 'GET',
                dataType: 'json',
                success: function (data) {
                    setTimeout(function () {
                        $list.empty();
                        if (!data.rtnData || data.rtnData.length === 0) {
                            renderEmpty();
                            return;
                        }

                        // ìµœì‹ ê¸€ì´ ì•„ë˜ë¡œ ê°€ë„ë¡ ìˆœì„œëŒ€ë¡œ append
                        data.rtnData.forEach(vo => {
                            $list.append(createCommentHtml(vo));
                        });

                        // [ìˆ˜ì •] ëª©ë¡ ë¡œë“œ ì™„ë£Œ í›„ ê°€ì¥ ì•„ë˜ìª½(ë§ˆì§€ë§‰ ê¸€)ìœ¼ë¡œ ìŠ¤í¬ë¡¤ ê³ ì •
                        $list.scrollTop($list.prop('scrollHeight'));
                    }, 500);
                },
                error: function () {
                    $list.html('<p class="text-center py-10 text-xs text-red-400">ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.</p>');
                }
            });
        }

        function createCommentHtml(vo) {
            const isMine = (vo.isMine === 'Y');
            // í´ë˜ìŠ¤ ê²°ì •: animate-fade-in-up ê°™ì€ Tailwind í´ë˜ìŠ¤ ëŒ€ì‹  CSS ì• ë‹ˆë©”ì´ì…˜ ì‚¬ìš©
            const itemClass = isMine ? 'db-lounge-item is-mine' : 'db-lounge-item others';
            // ì•„ë°”íƒ€ ì´ë¯¸ì§€ ì£¼ì†Œ (ì—ëŸ¬ ëŒ€ë¹„ ê¸°ë³¸ ì´ë¯¸ì§€ ì²˜ë¦¬ ì¶”ê°€ ê¶Œì¥)
            const avatarUrl = `https://cdn.jsdelivr.net/gh/ysrim/bjcc_ss@main/images/avatar/${vo.occpCode}_${vo.sexdstn.toLowerCase()}.png`;

            // HTML êµ¬ì¡° ì¬ì •ë¦½: ë¶ˆí•„ìš”í•œ ê³µë°± ì œê±° ë° êµ¬ì¡° ëª…í™•í™”
            return `
            <div class="${itemClass}" data-sn="${vo.postSn}">
                <img src="${avatarUrl}" alt="profile" onerror="this.src='/images/default_avatar.png'">

                <div class="db-lounge-content-wrapper">
                    <div class="db-lounge-info">
                        <span class="db-lounge-name">${vo.mberNm}</span>
                    </div>

                    <div class="db-lounge-bubble">
                        <span class="whitespace-pre-wrap">${vo.content}</span>
                        <button onclick="deleteComment(this)" class="db-lounge-del-btn" data-val="${vo.postSn}" title="ì‚­ì œ"><i class="fas fa-times"></i></button>
                    </div>

                    <span class="db-lounge-time">${vo.creatDe}</span>
                </div>
            </div>`;
        }

        // ë“±ë¡ ë²„íŠ¼ ë¡œë”© ì²˜ë¦¬ (ì•„ì´ì½˜ ë³€ê²½ ë°©ì‹ ìµœì í™”)
        function postComment() {
            const $input = $('#comment-input');
            const content = $input.val().trim();
            const $btn = $('#btn-reg-post');

            if (!content) {
                _showToast('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”! ğŸ˜Š');
                return;
            }

            // ë²„íŠ¼ ë¡œë”© ìƒíƒœ
            $btn.prop('disabled', true).addClass('opacity-70');
            const originalContent = $btn.html();
            $btn.html('<i class="fas fa-circle-notch fa-spin text-xs"></i><span class="text-xs font-bold">ë“±ë¡ ì¤‘</span>');

            $.ajax({
                url: '/tch/home/regGildPost.ax',
                type: 'POST',
                data: {content: content},
                success: function (res) {
                    $input.val('');
                    $('#comment-byte').text('0');
                    loadLoungeList(); // ì „ì²´ ì¬ë¡œë“œ í›„ ìŠ¤í¬ë¡¤ ë°”ë‹¥ìœ¼ë¡œ
                    _showToast(res.rtnMsg || 'ì„±ê³µì ìœ¼ë¡œ ê²Œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.');
                },
                complete: function () {
                    setTimeout(() => {
                        $btn.prop('disabled', false).removeClass('opacity-70').html(originalContent);
                    }, 500);
                }
            });
        }

        // 4. ë¹ˆ ëª©ë¡ ì²˜ë¦¬
        function renderEmpty() {
            $('#comment-list').html(`
		        <div id="empty-comment" class="db-lounge-empty">
		            <i class="fas fa-comments text-3xl mb-2 opacity-20"></i>
		            <p class="text-sm">ì•„ì§ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì²« ë²ˆì§¸ ì´ì•¼ê¸°ë¥¼ ë‚˜ëˆ ë³´ì„¸ìš”!</p>
		        </div>
		    `);
        }

        function scrollToBottom() {
            const $list = $('#comment-list');
            // scrollHeight: ì „ì²´ ë‚´ìš©ì˜ ë†’ì´, scrollTopì„ ì´ ê°’ìœ¼ë¡œ ì„¤ì •í•˜ë©´ ë§¨ ì•„ë˜ë¡œ ì´ë™í•©ë‹ˆë‹¤.
            $list.stop().animate({
                scrollTop: $list.prop('scrollHeight')
            }, 500);
        }

        $(function () {
            loadLoungeList(); // í˜ì´ì§€ ë¡œë“œ ì‹œ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        });
	</script>
</th:block>
</html>