<!DOCTYPE html>
<html xmlns:th="http//www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/app/psn/tch/layouts/tch_layout}" lang="ko">
<th:block layout:fragment="content">
	<section id="tab-home" class="section-content active">
		<div class="mb-6 px-1">
			<h2 class="text-2xl font-extrabold text-slate-900 flex items-center gap-2">
				[[${session.mberInfo.guildNm}]]길드 모험 브리핑
				<span class="text-[11px] font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded-lg border border-blue-100"
				      th:text="${new java.lang.String(dashboard.weekName, 'UTF-8')}">1월 4주</span>
			</h2>
			<p class="text-sm text-slate-400 mt-1">오늘의 왕국 활동 현황을 확인하세요.</p>
		</div>
		<div class="card-box p-7 bg-gradient-to-br from-blue-600 to-indigo-600 text-white border-0 shadow-lg relative">
			<div class="flex justify-between items-center mb-6 relative z-10">
				<div>
					<div class="text-blue-100 text-xs font-bold mb-1 opacity-80"
					     th:text="|출석현황 ${new java.lang.String(dashboard.monthName, 'UTF-8')}|">출석현황(02.01)
					</div>
					<div class="text-4xl font-black">[[${dashboard.atndCnt}]] <span
							class="text-lg opacity-70 font-medium" th:text="|/ ${dashboard.gildCnt}명|">/ 21명</span>
					</div>
				</div>
				<div class="text-right">
					<div class="text-blue-100 text-xs font-bold mb-1 opacity-80">누적 달란트</div>
					<div class="text-2xl font-black">[[${#numbers.formatInteger(dashboard.sumPoint, 1, 'COMMA')}]] <span
							class="text-sm opacity-70">P</span></div>
				</div>
			</div>
			<div class="grid grid-cols-4 gap-2 text-center border-t border-white/20 pt-6 relative z-10">
				<div>
					<div class="text-[10px] opacity-80 mb-1">대기</div>
					<div class="font-bold text-yellow-300" th:text="|${dashboard.pendingCnt}건|">3</div>
				</div>
				<div class="border-l border-white/20">
					<div class="text-[10px] opacity-80 mb-1">출석률</div>
					<div class="font-bold" th:text="|${dashboard.atndPct}%|">85%</div>
				</div>
				<div class="border-l border-white/20">
					<div class="text-[10px] opacity-80 mb-1">누적</div>
					<div class="font-bold" th:text="|${dashboard.totalAtndPct}%|">85%</div>
				</div>
				<div class="border-l border-white/20">
					<div class="text-[10px] opacity-80 mb-1">장결</div>
					<div class="font-bold text-red-300" th:text="|${dashboard.longAbsenceCnt}명|">85%</div>
				</div>
			</div>
			<div class="absolute -right-10 -bottom-10 w-40 h-40 bg-white/10 rounded-full blur-3xl"></div>
		</div>

		<div class="mt-6">
			<h3 class="font-bold text-slate-800 mb-3 px-1 flex items-center">
				<i class="fas fa-bullhorn text-blue-500 mr-2"></i>오늘의 메시지
			</h3>
			<div class="card-box p-5">
				<div id="banner-preview"
				     class="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-2xl p-4 mb-4 text-white shadow-md relative overflow-hidden transition-all duration-300">
					<div class="flex items-center gap-3 relative z-10">
						<div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
							<i class="fas fa-comment-dots"></i>
						</div>
						<p id="preview-text" class="flex-1 text-sm font-bold leading-snug" th:text="|${gildMsg}|">
							오늘의 공지사항이 여기에 표시됩니다.
						</p>
					</div>
				</div>

				<div class="flex gap-2 items-start">
					<div class="flex-1 relative">
                <textarea id="message-input" rows="2" placeholder="메시지 입력... (최대 400byte)"
                          onkeyup="checkByteLimit(this, 400)"
                          class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-100 resize-none transition-colors"></textarea>
						<div class="text-right px-1 mt-1">
							<span id="text-byte" class="text-[10px] text-blue-600 font-bold">0</span>
							<span class="text-[10px] text-slate-400">/ 400 byte</span>
						</div>
					</div>
					<button id="btn-save-msg" onclick="saveTodayMessage()"
					        class="w-14 h-[54px] bg-blue-600 text-white rounded-xl flex flex-col items-center justify-center shadow-md active:scale-95 transition hover:bg-blue-700 disabled:bg-slate-300 disabled:cursor-not-allowed">
						<i class="fas fa-paper-plane text-sm mb-0.5"></i>
						<span class="text-[10px] font-bold">게시</span>
					</button>
				</div>
			</div>
		</div>

		<div class="mt-8">
			<h3 class="font-bold text-slate-800 mb-3 px-1 flex justify-between">
				<span><i class="fas fa-comment-alt text-blue-500 mr-2"></i>길드 라운지</span>
				<span class="text-xs text-slate-400 font-normal mt-1">최근 게시글</span>
			</h3>
			<div class="card-box">
				<div id="comment-list" class="flex flex-col gap-4 p-4 max-h-[400px] overflow-y-auto custom-scrollbar">

					<div class="flex gap-3 group" th:each="vo : ${gildPost}">
						<div class="flex-shrink-0">
							<img th:src="|https://cdn.jsdelivr.net/gh/ysrim/bjcc_ss@main/images/avatar/${vo.occpCode}_${#strings.toLowerCase(vo.sexdstn)}.png|"
							     class="w-10 h-10 rounded-2xl bg-slate-100 border border-slate-200 shadow-sm object-cover">
						</div>

						<div class="flex-1 max-w-[90%]">
							<div class="flex justify-between items-end mb-1 pl-1">
								<span class="text-sm font-bold text-slate-900" th:text="${vo.mberNm}">김용사</span>
								<span class="text-[10px] text-slate-400 font-normal" th:text="${vo.creatDe}">10:42 AM</span>
							</div>

							<div class="relative bg-slate-50 border border-slate-100 rounded-2xl rounded-tl-none px-4 py-3 text-sm text-slate-700 leading-relaxed shadow-sm hover:bg-slate-100 transition-colors">
								<p th:text="${vo.content}" class="whitespace-pre-wrap break-words">선생님 오늘 간식 뭐예요?</p>

								<button th:onclick="|deleteComment(this, '${vo.postSn}')|"
								        class="absolute -top-2 -right-2 bg-white text-red-400 border border-red-100 w-6 h-6 rounded-full shadow-sm flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all hover:bg-red-50 hover:scale-110 cursor-pointer">
									<i class="fas fa-times text-[10px]"></i>
								</button>
							</div>
						</div>
					</div>

				</div>

				<div class="p-3 bg-white border-t border-slate-100 flex gap-2 rounded-b-2xl">
					<input id="comment-input" type="text" placeholder="함께 이야기를 나눠보세요..."
					       onkeyup="if(window.event.keyCode==13){postComment()}"
					       class="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-blue-100 focus:bg-white transition-colors">
					<button onclick="postComment()"
					        class="w-12 h-11 bg-slate-900 text-white rounded-xl flex items-center justify-center active:scale-95 transition shadow-md hover:bg-slate-800">
						<i class="fas fa-paper-plane text-xs"></i>
					</button>
				</div>
			</div>
		</div>
	</section>
	<script th:inline="javascript">

		function saveTodayMessage() {
			const $input = $('#message-input');
			const $preview = $('#preview-text');
			const $btn = $('#btn-save-msg');
			const $btnIcon = $btn.find('i');
			const $btnText = $btn.find('span');
			const message = $input.val().trim();
			// 1. 유효성 검사
			if (!message) {
				_showToast("메시지 내용을 입력해주세요. ❌");
				$input.focus();
				return;
			}
			// 2. 로딩 UI 시작
			const originalIconClass = "fas fa-paper-plane text-sm mb-0.5"; // 원래 아이콘 클래스
			$btn.prop('disabled', true);        // 버튼 비활성화
			$btnText.text('저장중');            // 텍스트 변경
			$btnIcon.attr('class', 'fas fa-circle-notch fa-spin text-lg mb-0.5'); // 스피너 아이콘으로 변경
			// 3. 서버 전송 (AJAX)
			$.ajax({
				url: '/tch/home/saveGildMsg.ax',
				type: 'POST',
				data: {slogan: message},
				success: function (response) {
					$preview.fadeOut(200, function () { // 성공 시 미리보기 텍스트 갱신 (깜빡임 효과)
						$(this).text(message).fadeIn(200);
					});
					$input.val(''); // 입력창 초기화
					$('#text-byte').text('0'); // 카운터 초기화
					_showToast('길드 메시지를 갱신했습니다. ✅');
				},
				error: function (xhr, status, error) {
					console.error("저장 실패:", error);
					_showToast("메시지 저장에 실패했습니다. 잠시 후 다시 시도해주세요. ❌");
				},
				complete: function () {
					setTimeout(function () { // 4. 로딩 UI 종료 (0.5초 딜레이로 자연스럽게)
						$btn.prop('disabled', false);
						$btnText.text('게시');
						$btnIcon.attr('class', originalIconClass);
					}, 500);
				}
			});
		}

		function checkByteLimit(obj, maxByte) {
			const str = obj.value;
			let totalByte = 0;
			let len = 0;
			for (let i = 0; i < str.length; i++) {
				const c = str.charCodeAt(i);
				if (c > 128) {
					totalByte += 2; // 한글 등은 2byte 처리 (UTF-8 3byte를 원하면 3으로 수정)
				} else {
					totalByte++;    // 영문 등은 1byte
				}
				if (totalByte <= maxByte) {
					len = i + 1;
				}
			}
			// Byte 표시 업데이트
			$('#text-byte').text(totalByte);
			// 제한 초과 시 자르기
			if (totalByte > maxByte) {
				alert("최대 " + maxByte + "Byte까지만 입력 가능합니다.");
				obj.value = str.substr(0, len);
				$('#text-byte').text(maxByte); // 강제로 max로 표기
			}
		}

		function postComment() {
			const $input = $('#comment-input');
			const val = $input.val().trim();

			if (!val) {
				_showToast('내용을 입력해주세요.'); // 토스트 메시지 함수가 있다면 사용
				$input.focus();
				return;
			}

			// 현재 시간 구하기 (단순 표기용)
			const now = new Date();
			const timeString = now.toLocaleTimeString('ko-KR', {hour: '2-digit', minute: '2-digit'});

			// 디자인이 적용된 HTML 구조
			const html = `
            <div class="flex gap-3 group animate-fade-in-up">
               <div class="flex-shrink-0">
                   <div class="w-10 h-10 rounded-2xl bg-indigo-100 border border-indigo-200 shadow-sm flex items-center justify-center text-indigo-600">
                        <i class="fas fa-user-tie text-lg"></i>
                   </div>
               </div>
               <div class="flex-1 max-w-[90%]">
                  <div class="flex justify-between items-end mb-1 pl-1">
                     <span class="text-sm font-bold text-slate-900">관리자(나)</span>
                     <span class="text-[10px] text-slate-400 font-normal">${timeString}</span>
                  </div>
                  <div class="relative bg-indigo-50 border border-indigo-100 rounded-2xl rounded-tl-none px-4 py-3 text-sm text-slate-800 leading-relaxed shadow-sm">
                     <p class="whitespace-pre-wrap break-words">${val}</p>
                     <button onclick="deleteComment(this)"
                             class="absolute -top-2 -right-2 bg-white text-red-400 border border-red-100 w-6 h-6 rounded-full shadow-sm flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all hover:bg-red-50 hover:scale-110 cursor-pointer">
                         <i class="fas fa-times text-[10px]"></i>
                     </button>
                  </div>
               </div>
            </div>`;

			$('#comment-list').prepend(html); // 상단에 추가
			$input.val(''); // 입력창 비우기
		}

		function deleteComment(btn, sn) {
			if (confirm('정말 삭제하시겠습니까?')) {
				$(btn).closest('.group').remove(); // 부모 요소(group) 제거
			}
		}

		$(function () {
		});
	</script>
</th:block>
</html>