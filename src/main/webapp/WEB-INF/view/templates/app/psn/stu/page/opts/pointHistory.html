<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	  layout:decorate="~{/app/psn/stu/layouts/std_layout}" lang="ko">
<th:block layout:fragment="content">
	<script src="/files/script/libs/qrcode.min.js"></script>
	<script th:inline="javascript">

		// ë°ì´í„° ë¶€ë¶„
		const historyData = [
			/*[# th:each="vo, stat : ${pointHistory}"]*/
			{
				type: '[(${vo.rewardType})]',
				changeType: '[(${vo.changeType})]',
				emoji: '[(${vo.emoji})]',
				title: '[(${vo.description})]',
				date: '[(${vo.creatDe})]',
				amount: [(${vo.amount}
		)],
		balance: [(${vo.balanceAfter}
		)]
		},
		/*[/]*/
		]
		;

		let currentHistoryFilter = '*';
		let currentPage = 1;
		const itemsPerPage = 7;
		let filteredData = [];

		function setHistoryFilter(filterType) {
			currentHistoryFilter = filterType;
			currentPage = 1;
			$('.filter-tab').removeClass('active');
			$(`.filter-tab[onclick="setHistoryFilter('${filterType}')"]`).addClass('active');
			renderHistory(true);
		}

		function loadMoreHistory() {
			currentPage++;
			renderHistory(false);
		}

		function renderHistory(reset = false) {
			const $list = $('#point-history-list');
			const $btnMore = $('#btn-load-more');

			if (reset) {
				$list.empty();
				if (currentHistoryFilter === '*') filteredData = historyData;
				else filteredData = historyData.filter(item => item.type === currentHistoryFilter);
			}

			const startIndex = (currentPage - 1) * itemsPerPage;
			const endIndex = startIndex + itemsPerPage;
			const pageData = filteredData.slice(startIndex, endIndex);

			if (filteredData.length === 0) {
				$list.html('<div class="empty-history text-light text-center" style="padding:20px;">ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤. í……! ğŸ—‘ï¸</div>');
				$btnMore.hide();
				return;
			}

			let lastDate = null;
			if (!reset && $('.history-date-header').last().length > 0) {
				lastDate = $('.history-date-header').last().data('date');
			}

			pageData.forEach(item => {
				if (item.date !== lastDate) {
					$list.append(`<div class="history-date-header" data-date="${item.date}" style="background: #f8f9fa; padding: 5px 10px; border-radius: 8px; display: inline-block; margin: 15px 5px 5px 5px; font-weight: bold; font-size: 0.75rem; color: #888;">${item.date}</div>`);
					lastDate = item.date;
				}

				const isPlus = item.amount > 0;
				const colorClass = isPlus ? 'text-blue' : 'text-red';
				const unit = item.type == 'POINT' ? 'P' : 'EXP';

				const html = `
                <div class="menu-item" style="cursor: default;">
                    <div class="flex-row">
                        <div class="flex-center" style="width: 40px; height: 40px; background: #F8F9FA; border-radius: 12px; font-size: 1.2rem; margin-right: 12px;">
                            ${item.emoji}
                        </div>
                        <div class="flex-col">
                            <span class="text-bold" style="font-size: 0.9rem; color:#333;">${item.changeType}</span>
                            <small class="text-light">${item.title}</small>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="${colorClass} text-bold" style="font-size: 1rem;">${item.amount.toLocaleString()} ${unit}</div>
                        ${item.balance ? `<small class="text-light">${unit}: ${item.balance.toLocaleString()}</small>` : '0'}
                    </div>
                </div>
            `;
				$list.append(html);
			});

			if (endIndex >= filteredData.length) {
				$btnMore.hide();
			} else {
				$btnMore.show();
				$btnMore.text(`ğŸ‘‡ ë” ë³´ê¸° (${filteredData.length - endIndex}ê°œ)`);
			}
		}


		$(function () {
			setHistoryFilter('*');
		});
	</script>
	<div style="margin: 25px 25px 10px 25px; display: flex; align-items: center;">
		<div style="width: 4px; height: 16px; background-color: #4A90E2; border-radius: 2px; margin-right: 10px;"></div>
		<h3 style="margin: 0; font-size: 1.15rem; color: #333; font-weight: 800;">í¬ì¸íŠ¸/ê²½í—˜ì¹˜ ë‚´ì—­</h3>
	</div>
	<div class="point-summary-card">
		<span style="font-size: 0.85rem; opacity: 0.8;">í˜„ì¬ ë³´ìœ  ë‹¬ë€íŠ¸</span>
		<h2 style="font-size: 3rem; font-weight: 800; margin: 15px 0 25px 0; letter-spacing: -1px;">
			<span class="sub-money" th:text="|${#numbers.formatInteger(_mberPoint, 3, 'COMMA')}|">2,500</span> <small style="font-size: 1.2rem;">P</small>
		</h2>
		<div class="flex-row"
			 style="justify-content: space-around; background: rgba(0,0,0,0.08); border-radius: 15px; padding: 12px; backdrop-filter: blur(5px);">
			<div class="flex-col flex-center text-sub" style="color: white;">
				<span>ë‹¬ë€íŠ¸ íšë“(ì´ë²ˆ ì£¼)</span>
				<strong style="font-size: 1rem;" th:text="|${#numbers.formatInteger(weekStatics.WEEK_POINT_SUM, 3, 'COMMA')}|"> P</strong>
			</div>
			<div style="width: 1px; height: 25px; background: rgba(255,255,255,0.3);"></div>
			<div class="flex-col flex-center text-sub" style="color: white;">
				<span>ê²½í—˜ì¹˜ íšë“(ì´ë²ˆ ì£¼)</span>
				<strong style="font-size: 1rem; color: #FFCDD2;" th:text="|${#numbers.formatInteger(weekStatics.WEEK_EXP_SUM, 3, 'COMMA')}|">-500 P</strong>
			</div>
		</div>
	</div>

	<div class="flex-row gap-10" style="margin: 20px 20px 10px 20px;">
		<button class="filter-tab active" onclick="setHistoryFilter('*')">ì „ì²´</button>
		<button class="filter-tab" onclick="setHistoryFilter('POINT')">ë‹¬ë€íŠ¸</button>
		<button class="filter-tab" onclick="setHistoryFilter('EXP')">ê²½í—˜ì¹˜</button>
	</div>
	<div class="menu-list" id="point-history-list" style="min-height: 200px;">
	</div>
	<button id="btn-load-more" class="btn-outline"
			style="display: block; width: 150px; margin: 20px auto 40px; padding: 10px 20px; border-radius: 50px;"
			onclick="loadMoreHistory()">ğŸ‘‡ ë” ë³´ê¸°
		(More)
	</button>
</th:block>
</html>