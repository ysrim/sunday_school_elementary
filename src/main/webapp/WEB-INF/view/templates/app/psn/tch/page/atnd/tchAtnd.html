<!DOCTYPE html>
<html xmlns:th="http//www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/app/psn/tch/layouts/tch_layout}" lang="ko">
<th:block layout:fragment="content">
    <section id="tab-attendance" class="section-content active">
        <h2 class="text-2xl font-bold text-slate-800 mb-5 px-1">출석 관리</h2>

        <div class="flex gap-2 mb-6 overflow-x-auto no-scrollbar pb-1" id="month-group"></div>
        <div class="card-box p-1.5 grid grid-cols-4 gap-1 mb-6" id="week-group"></div>

        <div class="flex gap-4 mb-4 items-center border-b border-slate-200" id="att-sub-tabs">
            <button data-type="pending" class="sub-tab active">
                승인 대기 <span class="text-blue-600 text-sm align-top font-bold" id="cnt-pending">0</span>
            </button>
            <button data-type="complete" class="sub-tab">
                완료됨 <span class="text-slate-400 text-sm align-top ml-0.5 font-bold" id="cnt-complete">0</span>
            </button>
        </div>

        <div id="list-att-pending" class="space-y-3 att-list"></div>
        <div id="list-att-complete" class="space-y-3 att-list hidden"></div>
    </section>

    <script th:inline="javascript">
        $(function () {
            // ==========================================
            // 1. 설정 및 상태 관리
            // ==========================================
            const CONFIG = {
                API: {
                    LIST: /*[[@{/tch/atnd/reqAtnd.ax}]]*/ '/tch/atnd/reqAtnd.ax',
                    UPDATE: /*[[@{/tch/atnd/atndChk.ax}]]*/ '/tch/atnd/atndChk.ax'
                },
                ANIMATION_DURATION: 300
            };

            const STATE = {
                year: new Date().getFullYear(),
                month: new Date().getMonth() + 1
            };

            // DOM 캐싱 (반복적인 탐색 방지)
            const $dom = {
                monthGroup: $('#month-group'),
                weekGroup: $('#week-group'),
                pendingCnt: $('#cnt-pending'),
                completeCnt: $('#cnt-complete'),
                pendingList: $('#list-att-pending'),
                completeList: $('#list-att-complete'),
                tabs: $('#att-sub-tabs .sub-tab'),
                loading: `
                    <div class="flex flex-col items-center justify-center p-12 w-full text-slate-400">
                        <i class="fas fa-circle-notch fa-spin text-3xl mb-3 text-blue-500"></i>
                        <p class="text-sm font-medium">데이터를 불러오는 중입니다...</p>
                    </div>`,
                empty: `<div class="text-center p-10 text-slate-400">내역이 없습니다.</div>`,
                error: `<div class="text-center p-10 text-red-400">데이터를 가져오지 못했습니다.</div>`
            };

            // ==========================================
            // 2. 헬퍼 함수
            // ==========================================
            const DateUtils = {
                format: (date) => {
                    const yyyy = date.getFullYear();
                    const mm = String(date.getMonth() + 1).padStart(2, '0');
                    const dd = String(date.getDate()).padStart(2, '0');
                    return `${yyyy}${mm}${dd}`;
                },
                getThisSunday: () => {
                    const today = new Date();
                    const sunday = new Date(today);
                    sunday.setDate(today.getDate() - today.getDay());
                    return DateUtils.format(sunday);
                }
            };

            // ==========================================
            // 3. 렌더링 로직
            // ==========================================

            // 월 버튼 초기화
            function initMonths() {
                let html = '';
                for (let m = 1; m <= 12; m++) {
                    const activeClass = m === STATE.month ? 'active' : '';
                    html += `<button class="chip ${activeClass}" data-value="${m}">${m}월</button>`;
                }
                $dom.monthGroup.html(html);
            }

            // 주차 렌더링 (성능 최적화: HTML 문자열 결합 후 1회 삽입)
            function renderWeeks(year, month) {
                const targetSunday = DateUtils.getThisSunday();
                let date = new Date(year, month - 1, 1);
                let weekCount = 1;
                let html = '';
                let hasActive = false;

                while (date.getMonth() === month - 1) {
                    if (date.getDay() === 0) { // 일요일
                        const dateStr = DateUtils.format(date);
                        const isActive = (dateStr === targetSunday);
                        if (isActive) hasActive = true;

                        html += `<button class="week-btn ${isActive ? 'active' : ''}" data-value="${dateStr}">${weekCount}주</button>`;
                        weekCount++;
                    }
                    date.setDate(date.getDate() + 1);
                }

                $dom.weekGroup.html(html);

                // 이번 달에 활성 주차가 없으면 마지막 주 자동 선택
                if (!hasActive) {
                    $dom.weekGroup.find('.week-btn').last().addClass('active');
                }

                // 데이터 로드 트리거
                $dom.weekGroup.find('.week-btn.active').trigger('click');
            }

            // 리스트 아이템 렌더링
            function renderList(list, type) {
                const isPending = type === 'pending';
                const $container = isPending ? $dom.pendingList : $dom.completeList;
                const $counter = isPending ? $dom.pendingCnt : $dom.completeCnt;

                // 카운트 업데이트
                $counter.text(list.length);
                $container.empty();

                if (!list.length) {
                    $container.html($dom.empty);
                    return;
                }

                const html = list.map(item => {
                    const isRejected = item.status === 'REJECTED';

                    // 스타일 및 텍스트 변수 처리 (가독성 향상)
                    const avatarClass = isPending ? 'bg-blue-50 text-blue-600' : 'bg-slate-100 text-slate-400';
                    const nameClass = isPending ? 'text-slate-800' : 'text-slate-400';
                    let statusInfo = '';

                    if (isPending) {
                        statusInfo = `<div class="text-xs text-slate-400 mt-0.5 font-bold">요청시간: ${item.creatDate}</div>`;
                    } else if (isRejected) {
                        statusInfo = `<div class="text-xs text-red-500 mt-0.5 font-bold">반려됨: ${item.processedDe}</div>`;
                    } else {
                        statusInfo = `<div class="text-xs text-green-600 mt-0.5 font-bold">승인완료: ${item.processedDe}</div>`;
                    }

                    // 버튼 영역
                    const actionHtml = isPending ? `
                        <div class="flex gap-2">
                             <button type="button" class="btn-action w-10 h-10 rounded-full bg-red-50 text-red-500 flex items-center justify-center active-scale-95 transition"
                                     data-status="REJECTED" data-id="${item.logSn}">
                                <i class="fas fa-times"></i>
                             </button>
                             <button type="button" class="btn-action w-10 h-10 rounded-full bg-blue-600 text-white shadow-lg flex items-center justify-center active-scale-95 transition"
                                     data-status="APPROVED" data-id="${item.logSn}">
                                <i class="fas fa-check"></i>
                             </button>
                        </div>`
                        : `<i class="fas ${isRejected ? 'fa-times-circle text-red-400' : 'fa-check-circle text-green-500'} text-xl"></i>`;

                    return `
                       <div class="card-box p-5 flex items-center justify-between ${!isPending ? '!border-slate-200 bg-white/60' : ''}">
                          <div class="flex items-center gap-4">
                             <div class="w-12 h-12 ${avatarClass} rounded-2xl flex items-center justify-center font-black text-lg">
                                ${item.mberNm.charAt(0)}
                             </div>
                             <div>
                                <div class="font-bold ${nameClass}">${item.mberNm}</div>
                                ${statusInfo}
                             </div>
                          </div>
                          ${actionHtml}
                       </div>`;
                }).join('');

                $container.html(html);
            }

            // ==========================================
            // 4. 비즈니스 로직 (AJAX)
            // ==========================================

            // 출석 상태 변경 요청
            function updateStatus(logSn, status, $btn) {
                const $card = $btn.closest('.card-box');
                const isApprove = status === 'APPROVED';

                const executeAjax = () => {
                    // 로딩 상태 표시 (승인 버튼일 때만)
                    if (isApprove) $btn.html('<i class="fas fa-spinner fa-spin"></i>');

                    $.ajax({
                        url: CONFIG.API.UPDATE,
                        type: 'POST',
                        data: {logSn, status},
                        success: (data) => {
                            if (data.rtnCd === '001') {
                                _showToast(data.rtnMsg || '처리가 완료되었습니다. ✅');

                                // 성공 애니메이션
                                if (isApprove) {
                                    $card.css({transform: 'scale(0.9)', opacity: '0', transition: '0.3s'});
                                    setTimeout(() => $card.slideUp(300, reloadList), 300);
                                } else {
                                    $card.css({'opacity': '0.5', 'filter': 'grayscale(1)', 'pointer-events': 'none'});
                                    setTimeout(reloadList, 500);
                                }
                            } else {
                                _showToast(`처리 실패: ${data.rtnMsg} ❌`);
                                resetBtn();
                            }
                        },
                        error: () => {
                            _showToast('서버 통신 오류 ❌');
                            resetBtn();
                        }
                    });
                };

                const resetBtn = () => {
                    $btn.html(isApprove ? '<i class="fas fa-check"></i>' : '<i class="fas fa-times"></i>');
                };

                // UX 로직: 승인은 즉시 실행, 반려(REJECTED)는 확인 절차 진행
                if (status === 'REJECTED') {
                    // _customConfirm이 있으면 사용, 없으면 기본 confirm 사용
                    if (typeof _customConfirm === 'function') {
                        _customConfirm('이 요청을 정말 반려하시겠습니까?', (isOk) => {
                            if (isOk) executeAjax();
                        });
                    } else if (confirm('정말 반려하시겠습니까?')) {
                        executeAjax();
                    }
                } else {
                    executeAjax(); // 승인은 즉시 실행
                }
            }

            // 리스트 데이터 조회
            function fetchList(selectedDate) {
                $('.att-list').html($dom.loading); // 로딩 표시

                $.ajax({
                    url: CONFIG.API.LIST,
                    type: 'POST',
                    data: {reqDate: selectedDate},
                    success: (data) => {
                        // 깜빡임 방지용 최소 지연
                        setTimeout(() => {
                            if (data.rtnCd === '001') {
                                const list = data.rtnData || [];
                                renderList(list.filter(i => i.status === 'PENDING'), 'pending');
                                renderList(list.filter(i => i.status !== 'PENDING'), 'complete');
                            } else {
                                $('.att-list').html($dom.error);
                            }
                        }, 200);
                    },
                    error: () => $('.att-list').html('<div class="text-center p-10 text-red-400">서버 오류가 발생했습니다.</div>')
                });
            }

            function reloadList() {
                $dom.weekGroup.find('.week-btn.active').trigger('click');
            }

            // ==========================================
            // 5. 이벤트 바인딩
            // ==========================================

            // 월 변경
            $dom.monthGroup.on('click', '.chip', function () {
                $(this).addClass('active').siblings().removeClass('active');
                renderWeeks(STATE.year, $(this).data('value'));
            });

            // 주 변경
            $dom.weekGroup.on('click', '.week-btn', function () {
                $(this).addClass('active').siblings().removeClass('active');
                fetchList($(this).data('value'));
            });

            // 탭 변경
            $dom.tabs.on('click', function () {
                const type = $(this).data('type');
                $(this).addClass('active').siblings().removeClass('active');
                $('.att-list').addClass('hidden');
                $(`#list-att-${type}`).removeClass('hidden').hide().fadeIn(200);
            });

            // 승인/반려 버튼 클릭 (이벤트 위임)
            $(document).on('click', '.btn-action', function (e) {
                e.preventDefault();
                const $btn = $(this);
                // 중복 클릭 방지
                if ($btn.prop('disabled')) return;

                updateStatus($btn.data('id'), $btn.data('status'), $btn);
            });

            // ==========================================
            // 6. 실행
            // ==========================================
            initMonths();
            renderWeeks(STATE.year, STATE.month);
        });
    </script>
</th:block>
</html>