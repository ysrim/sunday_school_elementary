<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/app/psn/mng/layouts/mng_layout}" lang="ko">
<th:block layout:fragment="content">
	<script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>

	<div id="page-quest" class="page-content w-full min-h-screen bg-[#f8f9fa] p-5 font-sans text-slate-600 animate-fade-in">
		<header class="mb-6 flex justify-between items-end">
			<div>
				<span class="px-2.5 py-0.5 rounded-full bg-indigo-50 text-indigo-600 text-[10px] font-bold uppercase tracking-wider mb-1 inline-block">Approval</span>
				<h1 class="text-2xl font-black text-slate-900 tracking-tight">Quest Management</h1>
				<p class="text-xs text-slate-500 mt-1 font-medium">학생들이 완료한 퀘스트를 확인하고 승인하거나 반려합니다.</p>
			</div>

			<div class="flex gap-3">
				<div class="bg-white px-4 py-2 rounded-xl border border-slate-200 shadow-sm flex items-center gap-3">
					<div class="w-8 h-8 rounded-lg bg-amber-50 flex items-center justify-center text-amber-500">
						<i class="fas fa-clock"></i>
					</div>
					<div>
						<p class="text-[10px] text-slate-400 font-bold uppercase">Pending</p>
						<p id="count-pending" class="text-lg font-black text-slate-800 leading-none">0</p>
					</div>
				</div>
				<div class="bg-white px-4 py-2 rounded-xl border border-slate-200 shadow-sm flex items-center gap-3">
					<div class="w-8 h-8 rounded-lg bg-emerald-50 flex items-center justify-center text-emerald-500">
						<i class="fas fa-check-double"></i>
					</div>
					<div>
						<p class="text-[10px] text-slate-400 font-bold uppercase">Approved</p>
						<p id="count-approved" class="text-lg font-black text-slate-800 leading-none">0</p>
					</div>
				</div>
			</div>
		</header>

		<div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm h-full flex flex-col">
			<div class="mb-5 flex justify-between items-center">
				<h2 class="text-sm font-black text-slate-800 flex items-center">
					<i class="fas fa-list-ul text-slate-400 mr-2"></i> 요청 목록
				</h2>

				<div class="flex items-center gap-2">
					<div class="relative group">
						<input type="text" id="tableSearchInput" placeholder="이름, 퀘스트 검색..."
						       class="pl-8 pr-3 py-1.5 bg-slate-50 border border-slate-200 rounded-lg text-[11px] font-bold outline-none focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300 w-48 transition">
						<i class="fas fa-search absolute left-2.5 top-2 text-slate-400 text-[10px] group-hover:text-indigo-500 transition-colors"></i>
					</div>
					<div class="h-4 w-px bg-slate-200"></div>

					<select id="statusFilter" class="bg-slate-50 border border-slate-200 text-slate-600 text-[11px] font-bold rounded-lg focus:ring-indigo-500 focus:border-indigo-500 block p-1.5 outline-none cursor-pointer hover:bg-slate-100 transition">
						<option value="ALL" selected>전체 상태</option>
						<option value="PENDING">대기 중</option>
						<option value="APPROVED">승인됨</option>
						<option value="REJECTED">반려됨</option>
					</select>

					<button id="btnExport" class="text-[10px] font-bold text-slate-500 bg-slate-100 hover:bg-slate-200 px-2.5 py-1.5 rounded-lg transition flex items-center">
						<i class="fas fa-file-excel text-green-600 mr-1.5"></i> 엑셀 저장
					</button>
				</div>
			</div>

			<div id="questGrid" class="ag-theme-quartz w-full h-[600px] rounded-xl overflow-hidden border border-slate-100"></div>
		</div>
	</div>

	<script th:inline="javascript">
		/*<![CDATA[*/
		const QuestManager = {
			gridApi: null,

			init() {
				this.grid.init();
				this.bindEvents();
				this.grid.loadData();
			},

			grid: {
				init() {
					const columnDefs = [
						{
							headerName: "요청시간", field: "creatDate", width: 140,
							cellClass: "text-[11px] text-slate-500 font-mono"
						},
						{
							headerName: "학생정보", field: "mberNm", width: 150,
							cellRenderer: params => {
								if (!params.value) return '';
								const initial = params.value.charAt(0);
								return `
                            <div class="flex items-center gap-2.5 h-full">
                               <div class="w-6 h-6 rounded-full bg-indigo-50 border border-indigo-100 flex items-center justify-center text-[10px] font-bold text-indigo-500">${initial}</div>
                               <div class="flex flex-col justify-center leading-tight">
                                   <span class="font-bold text-slate-700 text-xs">${params.value}</span>
                                   <span class="text-[9px] text-slate-400">${params.data.grade || '-'}학년 ${params.data.cla || '-'}반</span>
                               </div>
                            </div>`;
							}
						},
						{
							headerName: "퀘스트 내용", field: "description", flex: 1, minWidth: 200,
							cellRenderer: params => {
								const typeMap = {
									'DAILY': {icon: 'fa-calendar-day', color: 'text-slate-400', bg: 'text-slate-500'},
									'WEEKLY': {icon: 'fa-calendar-week', color: 'text-violet-500', bg: 'text-slate-700'},
									'SPECIAL': {icon: 'fa-star', color: 'text-amber-500', bg: 'text-amber-700'}
								};
								const config = typeMap[params.data.questType] || typeMap['DAILY'];
								return `
                            <div class="flex items-center h-full gap-2">
                               <i class="fas ${config.icon} ${config.color} text-[10px] w-4"></i>
                               <span class="text-xs font-bold ${config.bg} truncate">${params.value || ''}</span>
                            </div>`;
							}
						},
						{
							headerName: "보상", width: 130,
							cellRenderer: params => `
                         <div class="flex items-center h-full gap-3">
                            <span class="text-indigo-600 font-bold text-[11px] flex items-center">
                               <i class="fas fa-star text-[9px] mr-1 opacity-70"></i>${params.data.rewardExp || 0}
                            </span>
                            <span class="text-amber-600 font-bold text-[11px] flex items-center">
                               <i class="fas fa-coins text-[9px] mr-1 opacity-70"></i>${params.data.rewardPoint || 0}
                            </span>
                         </div>`
						},
						{
							headerName: "상태",
							field: "status",
							width: 100,
							cellClass: "flex items-center",
							cellRenderer: params => {
								const statusStyles = {
									'PENDING': {color: 'text-amber-500', icon: 'fa-hourglass-start', label: '대기'},
									'APPROVED': {color: 'text-emerald-600', icon: 'fa-check', label: '승인됨'},
									'REJECTED': {color: 'text-red-500', icon: 'fa-ban', label: '반려됨'}
								};
								const s = statusStyles[params.value] || statusStyles['PENDING'];
								// h-full을 추가하여 부모(셀)의 높이를 꽉 채우도록 합니다.
								return `<span class="${s.color} text-xs font-bold flex items-center h-full">
						                 <i class="fas ${s.icon} mr-1.5 text-[10px]"></i>${s.label}
						              </span>`;
							}
						},
						{
							headerName: "관리", field: "logSn", width: 110, sortable: false,
							cellClass: "flex items-center justify-center",
							cellRenderer: params => {
								if (params.data.status === 'PENDING') {
									return `
                                <div class="flex gap-2">
                                   <button onclick="QuestManager.api.updateStatus(${params.value}, 'APPROVED')" class="w-7 h-7 rounded-lg bg-indigo-600 hover:bg-indigo-700 text-white flex items-center justify-center transition shadow-sm">
                                      <i class="fas fa-check text-[10px]"></i>
                                   </button>
                                   <button onclick="QuestManager.api.updateStatus(${params.value}, 'REJECTED')" class="w-7 h-7 rounded-lg bg-white border border-slate-200 hover:bg-red-50 hover:text-red-500 text-slate-400 flex items-center justify-center transition shadow-sm">
                                      <i class="fas fa-times text-[10px]"></i>
                                   </button>
                                </div>`;
								}
								return '<span class="text-[10px] text-slate-300">처리완료</span>';
							}
						}
					];

					const gridOptions = {
						columnDefs,
						defaultColDef: {resizable: true, sortable: true, filter: true},
						pagination: true,
						paginationPageSize: 15,
						paginationPageSizeSelector: [15, 30, 50],
						rowHeight: 48,
						headerHeight: 44,
						overlayLoadingTemplate: '<div class="loader-inner"><i class="fas fa-circle-notch fa-spin text-indigo-500 text-2xl"></i></div>',
						isExternalFilterPresent: () => $('#statusFilter').val() !== 'ALL',
						doesExternalFilterPass: (node) => node.data.status === $('#statusFilter').val()
					};

					QuestManager.gridApi = agGrid.createGrid($('#questGrid')[0], gridOptions);
				},

				loadData() {
					QuestManager.gridApi.showLoadingOverlay();
					$.ajax({
						url: '/mng/qest/getQestLogList.ax',
						type: 'POST',
						contentType: "application/json",
						success: (res) => {
							const list = res.rtnData || [];
							QuestManager.gridApi.setGridOption('rowData', list);
							this.updateCounts(list);
							if (list.length === 0) QuestManager.gridApi.showNoRowsOverlay();
						},
						error: () => QuestManager.gridApi.showNoRowsOverlay()
					});
				},

				updateCounts(data) {
					const pending = data.filter(i => i.status === 'PENDING').length;
					const approved = data.filter(i => i.status === 'APPROVED').length;
					$('#count-pending').text(pending);
					$('#count-approved').text(approved);
				}
			},

			bindEvents() {
				$('#tableSearchInput').on('input', e => QuestManager.gridApi.setGridOption('quickFilterText', e.target.value));
				$('#statusFilter').on('change', () => QuestManager.gridApi.onFilterChanged());
				$('#btnExport').on('click', () => {
					const now = new Date().toISOString().split('T')[0];
					QuestManager.gridApi.exportDataAsCsv({fileName: `Quest_Report_${now}.csv`});
				});
			},

			api: {
				updateStatus(logSn, statusCode) {
					const msg = statusCode === 'APPROVED' ? "승인하시겠습니까?" : "반려하시겠습니까?";
					if (confirm(msg)) {
						$.ajax({
							url: '/mng/qest/qestProc.ax',
							type: 'POST',
							contentType: 'application/json',
							data: JSON.stringify({logSn: logSn, status: statusCode}),
							success: (res) => {
								Toast.success(res.rtnMsg);
								QuestManager.grid.loadData();
							},
							error: () => alert("처리 중 오류가 발생했습니다.")
						});
					}
				}
			}
		};

		$(() => QuestManager.init());
		/*]]>*/
	</script>
</th:block>
</html>