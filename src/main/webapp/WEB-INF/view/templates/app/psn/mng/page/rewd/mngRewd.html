<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{/app/psn/mng/layouts/mng_layout}" lang="ko">
<th:block layout:fragment="content">

	<script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.js"></script>

	<div id="page-adjustment" class="page-content w-full min-h-screen bg-[#f8f9fa] p-5 font-sans text-slate-600 animate-fade-in">

		<header class="mb-6">
			<span class="px-2.5 py-0.5 rounded-full bg-indigo-50 text-indigo-600 text-[10px] font-bold uppercase tracking-wider mb-1 inline-block">Rewards</span>
			<h1 class="text-2xl font-black text-slate-900 tracking-tight">Manual Adjustment</h1>
			<p class="text-xs text-slate-500 mt-1 font-medium">학생들에게 경험치(EXP)나 포인트(Gold)를 수동으로 지급하거나 차감합니다.</p>
		</header>

		<div class="grid grid-cols-1 lg:grid-cols-3 gap-5">
			<div class="lg:col-span-1">
				<div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm sticky top-5">
					<h2 class="text-sm font-black text-slate-800 flex items-center border-b border-slate-100 pb-3 mb-5">
						<i class="fas fa-sliders-h text-indigo-500 mr-2"></i> 지급 설정
					</h2>

					<form id="rewardForm" class="space-y-5" onsubmit="return false;">
						<input type="hidden" id="rewdMberSn" name="mberSn">

						<div>
							<label class="form-label font-bold text-xs text-slate-700 mb-1 block">대상 학생 <span class="text-red-500">*</span></label>
							<div class="relative group">
								<input type="text" id="targetStudentDisplay"
								       class="w-full pl-3 pr-9 py-2.5 bg-slate-50 border border-slate-200 rounded-xl text-sm font-bold focus:ring-2 focus:ring-indigo-100 focus:border-indigo-500 outline-none cursor-pointer hover:bg-white transition truncate"
								       placeholder="이름 검색 (클릭)" readonly>
								<button type="button" id="btnOpenModal"
								        class="absolute right-3 top-2.5 text-slate-400 hover:text-indigo-600 transition">
									<i class="fas fa-search"></i>
								</button>
							</div>
						</div>

						<div>
							<label class="form-label font-bold text-xs text-slate-700 mb-1 block">지급 유형 <span class="text-red-500">*</span></label>
							<div class="grid grid-cols-2 gap-3">
								<label class="cursor-pointer group">
									<input type="radio" name="rewardType" value="EXP" class="peer sr-only" checked>
									<div class="text-center py-3 rounded-xl border border-slate-200 transition-all group-hover:bg-slate-50 peer-checked:border-indigo-500 peer-checked:bg-indigo-50 peer-checked:text-indigo-700">
										<i class="fas fa-star mb-1 block text-sm"></i>
										<span class="text-xs font-bold">경험치 (EXP)</span>
									</div>
								</label>
								<label class="cursor-pointer group">
									<input type="radio" name="rewardType" value="POINT" class="peer sr-only">
									<div class="text-center py-3 rounded-xl border border-slate-200 transition-all group-hover:bg-slate-50 peer-checked:border-amber-500 peer-checked:bg-amber-50 peer-checked:text-amber-700">
										<i class="fas fa-coins mb-1 block text-sm"></i>
										<span class="text-xs font-bold">달란트 (POINT)</span>
									</div>
								</label>
							</div>
						</div>

						<div>
							<label class="form-label font-bold text-xs text-slate-700 mb-1 block">조정 방식</label>
							<div class="flex p-1 bg-slate-100 rounded-xl">
								<label class="flex-1 cursor-pointer">
									<input type="radio" name="actionType" value="ADD" class="peer sr-only" checked>
									<div class="text-center py-2 rounded-lg text-xs font-bold text-slate-500 peer-checked:bg-white peer-checked:text-indigo-600 peer-checked:shadow-sm transition-all">
										<i class="fas fa-plus mr-1"></i> 지급 (Add)
									</div>
								</label>
								<label class="flex-1 cursor-pointer">
									<input type="radio" name="actionType" value="SUB" class="peer sr-only">
									<div class="text-center py-2 rounded-lg text-xs font-bold text-slate-500 peer-checked:bg-white peer-checked:text-red-600 peer-checked:shadow-sm transition-all">
										<i class="fas fa-minus mr-1"></i> 차감 (Sub)
									</div>
								</label>
							</div>
						</div>

						<div class="grid grid-cols-3 gap-3">
							<div class="col-span-1">
								<label class="form-label font-bold text-xs text-slate-700 mb-1 block">수량 <span class="text-red-500">*</span></label>
								<input type="number" id="amountInput" min="1"
								       class="w-full text-center font-bold px-3 py-2.5 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-100 focus:border-indigo-500 outline-none"
								       placeholder="0" oninput="this.value = !!this.value && Math.abs(this.value) >= 0 ? Math.abs(this.value) : null">
							</div>
							<div class="col-span-2">
								<label class="form-label font-bold text-xs text-slate-700 mb-1 block">사유</label>
								<input type="text" id="reasonInput"
								       class="w-full px-3 py-2.5 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-100 focus:border-indigo-500 outline-none"
								       placeholder="예: 심부름 보상">
							</div>
						</div>

						<button type="button" id="btnSave"
						        class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl hover:bg-indigo-700 shadow-lg shadow-indigo-200 hover:shadow-xl transition-all text-xs flex items-center justify-center transform active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">
							<i class="fas fa-check-circle mr-2"></i> 설정 적용하기
						</button>
					</form>
				</div>
			</div>

			<div class="lg:col-span-2">
				<div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm h-full flex flex-col">
					<div class="mb-5 flex justify-between items-center">
						<h2 class="text-sm font-black text-slate-800 flex items-center">
							<i class="fas fa-history text-slate-400 mr-2"></i> 최근 조정 내역
						</h2>

						<div class="flex items-center gap-2">
							<div class="relative group">
								<input type="text" id="tableSearchInput" placeholder="내역 검색..."
								       class="pl-8 pr-3 py-1.5 bg-slate-50 border border-slate-200 rounded-lg text-[10px] font-bold outline-none focus:ring-2 focus:ring-indigo-100 focus:border-indigo-300 w-32 transition">
								<i class="fas fa-search absolute left-2.5 top-2 text-slate-400 text-[10px] group-hover:text-indigo-500 transition-colors"></i>
							</div>
							<div class="h-4 w-px bg-slate-200"></div>
							<button id="btnExport" class="text-[10px] font-bold text-slate-500 bg-slate-100 hover:bg-slate-200 px-2.5 py-1.5 rounded-lg transition flex items-center">
								<i class="fas fa-file-excel text-green-600 mr-1.5"></i> 엑셀
							</button>
						</div>
					</div>

					<div id="adjustmentGrid" class="ag-theme-quartz flex-1 min-h-[500px] rounded-xl overflow-hidden border border-slate-100"></div>
				</div>
			</div>
		</div>
	</div>

	<div id="studentModal" class="fixed inset-0 z-50 hidden" aria-hidden="true">
		<div class="absolute inset-0 bg-slate-900/40 backdrop-blur-sm transition-opacity" id="modalBackdrop"></div>

		<div class="relative w-full max-w-md mx-auto mt-20 bg-white rounded-2xl shadow-2xl overflow-hidden flex flex-col max-h-[80vh] animate-fade-in-up">
			<div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
				<h3 class="text-sm font-black text-slate-800">학생 검색</h3>
				<button id="btnCloseModal" class="text-slate-400 hover:text-slate-600 transition outline-none">
					<i class="fas fa-times"></i>
				</button>
			</div>

			<div class="p-4 border-b border-slate-100">
				<div class="relative">
					<input type="text" id="modalSearchInput" placeholder="이름을 입력하세요 (예: 김철수)"
					       class="w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-xl text-sm font-bold focus:ring-2 focus:ring-indigo-100 focus:border-indigo-500 outline-none">
					<i class="fas fa-search absolute left-4 top-3.5 text-slate-400"></i>
				</div>
			</div>

			<div id="modalLoading" class="hidden flex-col items-center justify-center py-10 text-slate-400">
				<i class="fas fa-spinner fa-spin text-2xl mb-2 text-indigo-500"></i>
				<span class="text-xs">학생 목록을 불러오는 중...</span>
			</div>

			<div class="overflow-y-auto p-2 flex-1 min-h-[300px]" id="studentListContainer">
			</div>
		</div>
	</div>

	<script th:inline="javascript">
		/*<![CDATA[*/
		const MANAGER_SN = [[${session.mngMberInfo.mberSn}]]; // Thymeleaf safe variable injection

		const RewardManager = {
			gridApi: null,
			studentDataCache: null,
			debounceTimer: null,

			init() {
				this.grid.init();
				this.bindEvents();
				this.grid.loadData();
			},

			// --- 1. Grid Logic ---
			grid: {
				init() {
					const columnDefs = [
						{
							headerName: "지급시간", field: "creatDate", width: 130,
							valueFormatter: (params) => {
								// 날짜 포맷팅 로직 (필요시 moment.js 등 사용)
								return params.value ? params.value.substring(0, 16) : '-';
							},
							cellClass: "text-[11px] text-slate-500 flex items-center"
						},
						{
							headerName: "이름", field: "mberNm", width: 110, filter: true,
							cellRenderer: (params) => {
								// 아바타 + 이름 렌더링
								const initial = params.value ? params.value.charAt(0) : '?';
								return `
                            <div class="flex items-center gap-2 h-full">
                               <div class="w-5 h-5 rounded-full bg-slate-100 flex items-center justify-center text-[9px] font-bold text-slate-500">${initial}</div>
                               <span class="font-bold text-slate-700 text-[11px]">${params.value}</span>
                            </div>
                         `;
							}
						},
						{
							headerName: "학년/반", valueGetter: (p) => `${p.data.grade}-${p.data.cla}`, width: 90,
							cellClass: "text-[11px] text-slate-500 flex items-center justify-center"
						},
						{
							headerName: "조정내용 (사유)", field: "description", flex: 1, minWidth: 150,
							cellClass: "text-[11px] text-slate-600 flex items-center"
						},
						{
							headerName: "변동값", field: "amount", width: 120,
							cellRenderer: (params) => {
								// 값에 따른 색상 및 아이콘 처리 (핵심 개선 사항)
								const amount = params.value;
								const type = params.data.rewardType;
								const isPlus = amount > 0;
								const colorClass = isPlus
									? (type === 'POINT' ? 'text-amber-600 bg-amber-50 border-amber-100' : 'text-indigo-600 bg-indigo-50 border-indigo-100')
									: 'text-red-600 bg-red-50 border-red-100';
								const icon = type === 'POINT' ? 'fa-coins' : 'fa-star';
								const sign = isPlus ? '+' : '';

								return `
                            <div class="flex items-center h-full">
                               <span class="px-2 py-0.5 rounded-md border ${colorClass} text-[10px] font-bold inline-flex items-center gap-1.5">
                                  <i class="fas ${icon} text-[9px] opacity-70"></i>
                                  ${sign}${amount.toLocaleString()}
                               </span>
                            </div>
                         `;
							}
						},
						{
							headerName: "담당자", field: "mngNm", width: 90,
							cellClass: "text-[10px] text-slate-400 flex items-center justify-center"
						}
					];

					const gridOptions = {
						columnDefs: columnDefs,
						rowData: [],
						defaultColDef: {resizable: true, sortable: true},
						pagination: true,
						paginationPageSize: 20,
						headerHeight: 40,
						rowHeight: 36,
						rowClass: "hover:bg-slate-50 transition-colors",
						domLayout: 'normal', // autoHeight 대신 normal 사용 (스크롤바 생성)
						overlayNoRowsTemplate: '<div class="text-xs text-slate-400 py-10">조정 내역이 없습니다.</div>',
						overlayLoadingTemplate: '<div class="text-xs font-bold text-indigo-500"><i class="fas fa-spinner fa-spin mr-2"></i>Loading...</div>'
					};

					const gridDiv = document.querySelector('#adjustmentGrid');
					RewardManager.gridApi = agGrid.createGrid(gridDiv, gridOptions);
				},

				loadData() {
					const api = RewardManager.gridApi;
					if (api) api.showLoadingOverlay();

					$.ajax({
						url: '/mng/rewd/getRewdHistList.ax',
						type: 'POST',
						contentType: "application/json",
						success: function (res) {
							const data = res.rtnData || [];
							if (api) {
								api.setGridOption('rowData', data); // 매핑 없이 원본 데이터 주입 (ValueGetter/Renderer 활용)
								data.length === 0 ? api.showNoRowsOverlay() : api.hideOverlay();
							}
						},
						error: function (e) {
							console.error("Load Error", e);
							if (api) api.setGridOption('rowData', []);
						}
					});
				}
			},

			// --- 2. Event Listeners ---
			bindEvents() {
				const self = this;

				// Modal
				$('#targetStudentDisplay, #btnOpenModal').on('click', () => self.modal.open());
				$('#modalBackdrop, #btnCloseModal').on('click', () => self.modal.close());

				// Search with Debounce
				$('#modalSearchInput').on('input', function () {
					const keyword = $(this).val();
					clearTimeout(self.debounceTimer);
					self.debounceTimer = setTimeout(() => self.modal.filterList(keyword), 300); // 300ms 딜레이
				});

				// Save Action
				$('#btnSave').on('click', () => self.api.save());

				// Grid Search & Export
				$('#tableSearchInput').on('input', function () {
					if (self.gridApi) self.gridApi.setGridOption('quickFilterText', $(this).val());
				});
				$('#btnExport').on('click', function () {
					if (self.gridApi) self.gridApi.exportDataAsCsv({fileName: `Reward_Adjustment_${new Date().toISOString().slice(0, 10)}.csv`});
				});
			},

			// --- 3. Modal Logic ---
			modal: {
				open() {
					$('#studentModal').removeClass('hidden');
					$('body').addClass('overflow-hidden'); // 배경 스크롤 방지
					$('#modalSearchInput').val('').focus();

					if (!RewardManager.studentDataCache) {
						this.fetchData();
					} else {
						this.renderList(RewardManager.studentDataCache);
					}
				},
				close() {
					$('#studentModal').addClass('hidden');
					$('body').removeClass('overflow-hidden');
				},
				fetchData() {
					$('#studentListContainer').hide();
					$('#modalLoading').removeClass('hidden').addClass('flex');

					$.ajax({
						url: '/mng/rewd/getStdList.ax',
						type: 'POST',
						contentType: "application/json",
						success: function (res) {
							RewardManager.studentDataCache = res.rtnData || [];
							RewardManager.modal.renderList(RewardManager.studentDataCache);
						},
						complete: function () {
							$('#modalLoading').removeClass('flex').addClass('hidden');
							$('#studentListContainer').show();
						}
					});
				},
				renderList(data) {
					const container = $('#studentListContainer');
					container.empty();

					if (!data || data.length === 0) {
						container.html(`<div class="text-center py-10 text-slate-400 text-xs">검색 결과가 없습니다.</div>`);
						return;
					}

					// Document Fragment를 사용하여 DOM 조작 최소화 (성능 향상)
					const fragment = document.createDocumentFragment();

					data.forEach(student => {
						const imgSrc = `https://cdn.jsdelivr.net/gh/ysrim/bjcc_ss@main/images/avatar/${student.occpCode || 'default'}_${(student.sexdstn || 'M').toLowerCase()}.png`;

						const div = document.createElement('div');
						div.className = "student-item flex items-center gap-3 p-3 rounded-xl hover:bg-slate-50 cursor-pointer transition border border-transparent hover:border-indigo-100 group";
						div.onclick = () => RewardManager.modal.select(student);

						div.innerHTML = `
                      <div class="w-10 h-10 rounded-full bg-slate-100 overflow-hidden border border-slate-200 flex-shrink-0">
                         <img src="${imgSrc}" alt="Avatar" class="w-full h-full object-cover" onerror="this.src='https://placehold.co/40x40?text=U'">
                      </div>
                      <div>
                         <div class="font-bold text-sm text-slate-800 group-hover:text-indigo-600">${student.mberNm}</div>
                         <div class="text-[10px] text-slate-400 font-medium">${student.grade}학년 ${student.cla}반 · ${student.occpNm || '-'}</div>
                      </div>
                      <i class="fas fa-chevron-right ml-auto text-slate-300 text-xs group-hover:text-indigo-400"></i>
                   `;
						fragment.appendChild(div);
					});
					container.append(fragment);
				},
				filterList(keyword) {
					if (!RewardManager.studentDataCache) return;
					const lowerKey = keyword.toLowerCase();
					const filtered = RewardManager.studentDataCache.filter(s => s.mberNm.includes(lowerKey));
					this.renderList(filtered);
				},
				select(student) {
					$('#targetStudentDisplay').val(`${student.mberNm} (${student.grade}학년 ${student.cla}반)`);
					$('#rewdMberSn').val(student.mberSn);
					this.close();
				}
			},

			// --- 4. API Actions ---
			api: {
				save() {
					const mberSn = $('#rewdMberSn').val();
					const amountVal = $('#amountInput').val();
					const reason = $('#reasonInput').val();
					const rewardType = $('input[name="rewardType"]:checked').val();
					const actionType = $('input[name="actionType"]:checked').val(); // ADD or SUB

					// Validation
					if (!mberSn) return alert("학생을 먼저 선택해주세요.");
					if (!amountVal || amountVal <= 0) {
						alert("유효한 수량을 입력해주세요.");
						return $('#amountInput').focus();
					}

					// Data Construction
					const finalAmount = parseInt(amountVal) * (actionType === 'ADD' ? 1 : -1);
					const reqData = {
						mberSn: mberSn,
						rewardType: rewardType,
						amount: finalAmount,
						description: reason,
						changeType: 'ADMIN_MANUAL',
						referenceSn: MANAGER_SN // 상단에서 정의한 상수 사용
					};

					const actionTxt = actionType === 'ADD' ? '지급' : '차감';
					if (!confirm(`[${rewardType}] ${amountVal}을 ${actionTxt}하시겠습니까?`)) return;

					// Disable button to prevent double submit
					const btn = $('#btnSave');
					btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-2"></i> 처리 중...');

					$.ajax({
						url: '/mng/rewd/saveRewd.ax',
						type: 'POST',
						data: JSON.stringify(reqData),
						contentType: 'application/json',
						success: function () {
							alert("정상적으로 처리되었습니다.");
							// Reset Form
							$('#amountInput').val('');
							$('#reasonInput').val('');
							// Reload Grid
							RewardManager.grid.loadData();
						},
						error: function (xhr) {
							alert("오류가 발생했습니다: " + (xhr.statusText || 'Unknown Error'));
						},
						complete: function () {
							btn.prop('disabled', false).html('<i class="fas fa-check-circle mr-2"></i> 설정 적용하기');
						}
					});
				}
			}
		};

		$(function () {
			RewardManager.init();
		});
		/*]]>*/
	</script>
</th:block>
</html>