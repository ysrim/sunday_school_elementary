<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="icon" type="image/png" sizes="16x16" href="/files/favicon-16x16.png">
	<meta name="msapplication-TileColor" content="#ffffff">
	<meta name="theme-color" content="#ffffff">
	<title>봉동중앙교회 초등부 RPG - 로그인</title>
	<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/3.0.5/js.cookie.min.js"></script>
	<link rel="stylesheet" th:href="@{/files/css/login_style.css}">
</head>

<script th:inline="javascript">
    /*<![CDATA[*/
    $(function () {
        'use strict';

        // 1. 설정 및 상수
        const CONFIG = {
            urls: {
                login: /*[[@{/std/idx/login.ax}]]*/ '/std/idx/login.ax',
                home: /*[[@{/std/home.pg}]]*/ '/std/home.pg',
                join: /*[[@{/std/idx/join.pg}]]*/ '/std/idx/join.pg'
            },
            messages: {
                idEmpty: '아이디를 입력해주세요!',
                pwEmpty: '비밀번호를 입력해주세요!',
                error: '서버 통신 중 오류가 발생했습니다. 잠시 후 다시 시도해주세요.'
            },
            cookieKey: 'saved_mberId'
        };

        const LoginApp = {
            init: function () {
                this.cacheDOM();
                this.bindEvents();
                this.checkSavedId();
            },

            cacheDOM: function () {
                this.$idInput = $('#mberId');
                this.$pwInput = $('#pwd');
                this.$loginBtn = $('.btn-main-login');
                this.$saveIdCheck = $('#save-id');
                this.$alert = $('#custom-alert');
                this.$alertMsg = $('#alert-message');
                this.$alertIcon = $('#alert-icon');
                this.$alertTitle = $('#alert-title');
                this.$alertConfirm = $('.custom-alert-confirm');
            },

            bindEvents: function () {
                this.$loginBtn.on('click', () => this.handleLogin());
                this.$pwInput.on('keyup', (e) => {
                    if (e.key === 'Enter') this.handleLogin();
                });
                this.$alertConfirm.on('click', () => this.closePopup());
            },

            // ✅ js-cookie 사용: 읽기 (Cookies.get)
            checkSavedId: function () {
                const savedId = Cookies.get(CONFIG.cookieKey);

                if (savedId) {
                    this.$idInput.val(savedId);
                    this.$saveIdCheck.prop('checked', true);
                }
            },

            // ✅ js-cookie 사용: 쓰기/삭제 (Cookies.set / Cookies.remove)
            handleCookie: function (id) {
                if (this.$saveIdCheck.is(':checked')) {
                    // 30일 저장, 모든 경로에서 접근 가능하도록 path 설정
                    Cookies.set(CONFIG.cookieKey, id, {expires: 30, path: '/'});
                } else {
                    Cookies.remove(CONFIG.cookieKey, {path: '/'});
                }
            },

            handleLogin: function () {
                const mberId = this.$idInput.val().trim();
                const pwd = this.$pwInput.val();

                if (!mberId) {
                    this.showPopup(CONFIG.messages.idEmpty, '⚠️', '아이디 입력', () => this.$idInput.focus());
                    return;
                }
                if (!pwd) {
                    this.showPopup(CONFIG.messages.pwEmpty, '🔑', '비밀번호 입력', () => this.$pwInput.focus());
                    return;
                }

                this.setLoading(true);

                $.ajax({
                    type: "POST",
                    url: CONFIG.urls.login,
                    contentType: "application/json; charset=utf-8",
                    data: JSON.stringify({mberId: mberId, pwd: pwd}),
                    success: (data) => {
                        if (data.rtnCd === '001') {
                            this.handleCookie(mberId); // 쿠키 처리
                            this.showPopup(data.rtnMsg, '✨', '환영합니다!', () => {
                                location.href = CONFIG.urls.home;
                            });
                        } else {
                            this.setLoading(false);
                            this.showPopup(data.rtnMsg || '로그인 실패', '❌', '인증 실패');
                        }
                    },
                    error: (e) => {
                        console.error(e);
                        this.setLoading(false);
                        this.showPopup(CONFIG.messages.error, '🔥', '오류 발생');
                    }
                });
            },

            setLoading: function (isLoading) {
                if (isLoading) {
                    this.$loginBtn.prop('disabled', true).text('로그인 중...');
                } else {
                    this.$loginBtn.prop('disabled', false).text('로그인');
                }
            },

            showPopup: function (msg, icon = '✨', title = '알림', callback) {
                this.$alertMsg.html(msg);
                this.$alertIcon.html(icon);
                this.$alertTitle.text(title);
                this.$alert.css('display', 'flex').addClass('active');
                this.currentCallback = callback;
            },

            closePopup: function () {
                this.$alert.removeClass('active').css('display', 'none');
                if (this.currentCallback && typeof this.currentCallback === 'function') {
                    this.currentCallback();
                    this.currentCallback = null;
                }
            }
        };

        LoginApp.init();
    });
    /*]]>*/
</script>

<body>
<div class="app-container">
	<div class="page active">
		<div class="sub-header">
			<div class="sub-header-left">
				<h2>봉동중앙교회 초등부 RPG - 로그인</h2>
			</div>
		</div>
		<h3>반가워요! 믿음의 용사님</h3>
		<div class="card">
			<input type="text" id="mberId" placeholder="이름을 입력하세요">
			<input type="password" id="pwd" placeholder="비밀번호">
			<div class="login-options">
				<label class="checkbox-label">
					<input type="checkbox" id="save-id"> 아이디 저장
				</label>
				<!--<label class="checkbox-label">
					<input type="checkbox" id="auto-login"> 자동 로그인
				</label>-->
			</div>
			<button class="btn btn-main btn-main-login">로그인</button>

			<button class="btn btn-sub" th:onclick="|location.href='@{/std/idx/join.pg}'|">처음 왔어요 (회원가입)</button>
		</div>
	</div>

	<div id="custom-alert"
	     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
		<div class="card"
		     style="max-width:400px; width:320px; text-align:center; padding:30px; transform: scale(0.9); transition: transform 0.2s;">
			<div id="alert-icon" style="font-size: 3rem; margin-bottom: 15px;">✨</div>
			<h4 id="alert-title" style="margin-bottom: 10px; color: var(--secondary);">알림</h4>
			<p id="alert-message"
			   style="font-size: 0.95rem; color: #666; margin-bottom: 25px; line-height: 1.5; word-break: keep-all;"></p>
			<button class="btn btn-main custom-alert-confirm" style="margin-top:0;">확인</button>
		</div>
	</div>
</div>
</body>
</html>