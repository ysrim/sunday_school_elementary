<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>ë´‰ë™ì¤‘ì•™êµíšŒ ì´ˆë“±ë¶€ RPG - íšŒì›ê°€ì…</title>
	<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<link rel="stylesheet" th:href="@{/files/css/join_style.css}">
	<script th:inline="javascript">
		/*<![CDATA[*/
		$(function () {
			'use strict';

			const CONFIG = {
				urls: {
					checkId: /*[[@{/idx/idDupleChk.ax}]]*/ '/idx/idDupleChk.ax',
					join: /*[[@{/idx/join.ax}]]*/ '/idx/join.ax',
					login: /*[[@{/idx/login.pg}]]*/ '/idx/login.pg'
				}
			};

			const JoinApp = {
				isIdChecked: false,

				init: function () {
					this.cacheDOM();
					this.bindEvents();
					this.updateClassOptions();
				},

				cacheDOM: function () {
					this.$form = $('#joinFm');
					this.$idInput = $('#mberId');
					this.$pwInput = $('#pwd');
					this.$pwConfirm = $('#pwd-confirm');
					this.$nameInput = $('#mberNm');
					this.$nickInput = $('#ncnm');
					this.$occpInput = $('#occpCode');
					this.$gradeSelect = $('#grade');
					this.$classSelect = $('#cls');
					this.$avatars = $('.avatar-item');
					this.$msgId = $('#msg-id');
					this.$msgPw = $('#msg-pw');

					// âœ… ì„±ë³„ ë¼ë””ì˜¤ ë²„íŠ¼ ê·¸ë£¹ ì¶”ê°€ (name ì†ì„±ìœ¼ë¡œ ì„ íƒ)
					this.$genderInputs = $('input[name="sexdstnCode"]');

					this.$alert = $('#custom-alert');
					this.$alertMsg = $('#alert-message');
					this.$alertIcon = $('#alert-icon');
					this.$alertTitle = $('#alert-title');
					this.$alertConfirm = $('.custom-alert-confirm');
				},

				bindEvents: function () {
					this.$avatars.on('click', (e) => this.handleAvatarSelect(e));
					this.$idInput.on('input', () => {
						this.isIdChecked = false;
						this.$msgId.text('').removeClass('msg-success msg-error');
					});
					$('#btn-check-id').on('click', () => this.checkIdDuplicate());
					this.$pwInput.add(this.$pwConfirm).on('input', () => this.checkPasswordMatch());
					this.$gradeSelect.on('change', () => this.updateClassOptions());
					$('#btn-submit').on('click', () => this.handleSubmit());
					this.$alertConfirm.on('click', () => this.closePopup());
				},

				handleAvatarSelect: function (e) {
					const $target = $(e.currentTarget);
					this.$avatars.removeClass('selected');
					$target.addClass('selected');
					this.$occpInput.val($target.data('id'));
				},

				checkIdDuplicate: function () {
					const inputId = this.$idInput.val().trim();
					if (inputId.length < 5) {
						this.setMessage(this.$msgId, 'ì•„ì´ë””ëŠ” 5ê¸€ì ì´ìƒì´ì–´ì•¼ í•´ìš”.', false);
						this.$idInput.focus();
						return;
					}
					$.ajax({
						type: "GET",
						url: CONFIG.urls.checkId,
						data: {mberId: inputId},
						success: (data) => {
							if (data.rtnCd === '001') {
								this.setMessage(this.$msgId, 'ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤!', true);
								this.isIdChecked = true;
							} else {
								this.setMessage(this.$msgId, 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.', false);
								this.isIdChecked = false;
							}
						},
						error: (e) => {
							console.error(e);
							this.showPopup('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'ğŸ”¥', 'ì˜¤ë¥˜');
						}
					});
				},

				checkPasswordMatch: function () {
					const pw = this.$pwInput.val();
					const pwConfirm = this.$pwConfirm.val();
					if (!pw && !pwConfirm) {
						this.$msgPw.text('');
						return;
					}
					if (pw === pwConfirm) {
						this.setMessage(this.$msgPw, 'ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•©ë‹ˆë‹¤.', true);
					} else {
						this.setMessage(this.$msgPw, 'ë¹„ë°€ë²ˆí˜¸ê°€ ì„œë¡œ ë‹¬ë¼ìš”.', false);
					}
				},

				updateClassOptions: function () {
					const grade = this.$gradeSelect.val();
					const maxClass = (grade === '5') ? 4 : 6;
					const currentVal = this.$classSelect.val();
					this.$classSelect.empty();
					for (let i = 1; i <= maxClass; i++) {
						this.$classSelect.append(`<option value="${i}">${i}ë°˜</option>`);
					}
					if (currentVal && currentVal <= maxClass) {
						this.$classSelect.val(currentVal);
					}
				},

				handleSubmit: function () {
					if (!this.validateForm()) return;
					$.ajax({
						type: "POST",
						url: CONFIG.urls.join,
						data: this.$form.serialize(),
						success: (data) => {
							if (data.rtnCd === '001') {
								this.showPopup(`ê°€ì…ì„ ì¶•í•˜í•©ë‹ˆë‹¤!<br>${this.$nameInput.val()} ìš©ì‚¬ë‹˜!`, 'ğŸ‰', 'í™˜ì˜í•©ë‹ˆë‹¤', () => {
									location.href = CONFIG.urls.login;
								});
							} else {
								this.showPopup(data.rtnMsg || 'ê°€ì… ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'âŒ', 'ì‹¤íŒ¨');
							}
						},
						error: (e) => {
							console.error(e);
							this.showPopup('ê°€ì… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'ğŸ”¥', 'ì˜¤ë¥˜');
						}
					});
				},

				validateForm: function () {
					const mberId = this.$idInput.val().trim();
					const pw = this.$pwInput.val();
					const pwConfirm = this.$pwConfirm.val();
					const name = this.$nameInput.val().trim();
					const ncnm = this.$nickInput.val().trim();
					const occp = this.$occpInput.val();

					// âœ… ì„±ë³„ ì„ íƒ ì—¬ë¶€ í™•ì¸ (checked ëœ ìš”ì†Œê°€ 0ê°œë©´ ì„ íƒ ì•ˆ í•¨)
					const isGenderSelected = this.$genderInputs.is(':checked');

					if (!mberId) return this.warn('ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', this.$idInput);
					if (!this.isIdChecked) return this.warn('ì•„ì´ë”” ì¤‘ë³µí™•ì¸ì„ í•´ì£¼ì„¸ìš”!', this.$idInput);
					if (pw.length < 4) return this.warn('ë¹„ë°€ë²ˆí˜¸ë¥¼ 4ìë¦¬ ì´ìƒ ì…ë ¥í•´ì£¼ì„¸ìš”.', this.$pwInput);
					if (pw !== pwConfirm) return this.warn('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', this.$pwConfirm);
					if (!name) return this.warn('ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!', this.$nameInput);

					// âœ… ì„±ë³„ ê²€ì¦ ë¡œì§ ì¶”ê°€
					if (!isGenderSelected) return this.warn('ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”!', null);

					if (!ncnm) return this.warn('ìºë¦­í„° ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!', this.$nickInput);
					if (!occp) return this.warn('ìºë¦­í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!', null);

					return true;
				},

				warn: function (msg, $target) {
					this.showPopup(msg, 'âš ï¸', 'í™•ì¸ í•„ìš”', () => {
						if ($target) $target.focus();
					});
					return false;
				},

				setMessage: function ($el, text, isSuccess) {
					$el.text(text)
						.removeClass('msg-success msg-error')
						.addClass(isSuccess ? 'msg-success' : 'msg-error');
				},

				showPopup: function (msg, icon = 'âœ¨', title = 'ì•Œë¦¼', callback) {
					this.$alertMsg.html(msg);
					this.$alertIcon.html(icon);
					this.$alertTitle.text(title);
					this.$alert.css('display', 'flex').addClass('active');
					this.currentCallback = callback;
				},

				closePopup: function () {
					this.$alert.removeClass('active').css('display', 'none');
					if (this.currentCallback && typeof this.currentCallback === 'function') {
						this.currentCallback();
						this.currentCallback = null;
					}
				}
			};

			JoinApp.init();
		});
		/*]]>*/
	</script>
</head>
<body>
<div class="app-container">
	<div class="page active">
		<div class="sub-header">
			<div class="sub-header-left">
				<h2>ë´‰ë™ì¤‘ì•™êµíšŒ ì´ˆë“±ë¶€ RPG - íšŒì›ê°€ì…</h2>
			</div>
		</div>
		<h3>ë¯¿ìŒì˜ ìš©ì‚¬ê°€ ë˜ì–´ë³¼ê¹Œìš”?</h3>
		<form id="joinFm" th:object="${joinFm}" onsubmit="return false;">
			<div class="card">
				<label for="mberId">ì•„ì´ë””</label>
				<div class="input-group">
					<input type="text" th:field="*{mberId}" placeholder="ì•„ì´ë”” (ì˜ë¬¸, ìˆ«ì 5ì ì´ìƒ)">
					<button type="button" class="btn-check" id="btn-check-id">ì¤‘ë³µí™•ì¸</button>
				</div>
				<p id="msg-id" class="validation-msg"></p>
				<label for="pwd">ë¹„ë°€ë²ˆí˜¸</label>
				<input type="password" th:field="*{pwd}" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (4ì ì´ìƒ)">
				<label for="pwd-confirm">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
				<input type="password" id="pwd-confirm" placeholder="í•œ ë²ˆ ë” ì…ë ¥í•´ì£¼ì„¸ìš”">
				<p id="msg-pw" class="validation-msg"></p>
				<label for="mberNm">ì´ë¦„</label>
				<input type="text" th:field="*{mberNm}" placeholder="ì‹¤ëª…ì„ ì ì–´ì£¼ì„¸ìš”">
				<label>ì„±ë³„ì„ ì„ íƒí•´ì£¼ì„¸ìš”</label>
				<div class="radio-group">
					<label class="radio-label">
						<input type="radio" th:field="*{sexdstnCode}" value="M">
						ë‚¨ì ìš©ì‚¬
					</label>
					<label class="radio-label">
						<input type="radio" th:field="*{sexdstnCode}" value="F">
						ì—¬ì ìš©ì‚¬
					</label>
				</div>
				<label for="ncnm">ìºë¦­í„° ì´ë¦„</label>
				<input type="text" th:field="*{ncnm}" placeholder="ë©‹ì§„ ìºë¦­í„° ì´ë¦„ì„ ì§€ì–´ì£¼ì„¸ìš”">
				<label>ë‚˜ì˜ ìºë¦­í„° ì„ íƒ</label>
				<input type="hidden" th:field="*{occpCode}">
				<div class="avatar-grid" id="avatar-selector">
					<div class="avatar-item" data-id="001">
						<img src="https://cdn.jsdelivr.net/gh/ysrim/bjcc_ss@main/images/avatar/warrior_m.png" alt="ì „ì‚¬">
						<span>ë¯¿ìŒì˜ ì „ì‚¬</span>
					</div>
					<div class="avatar-item" data-id="002">
						<img src="https://cdn.jsdelivr.net/gh/ysrim/bjcc_ss@main/images/avatar/guardian_m.png" alt="ìˆ˜í˜¸ì">
						<span>ì ˆì œì˜ ìˆ˜í˜¸ì</span>
					</div>
					<div class="avatar-item" data-id="003">
						<img src="https://cdn.jsdelivr.net/gh/ysrim/bjcc_ss@main/images/avatar/paladin_m.png" alt="ì„±ê¸°ì‚¬">
						<span>ì†Œë§ì˜ ì„±ê¸°ì‚¬</span>
					</div>
					<div class="avatar-item" data-id="004">
						<img src="https://cdn.jsdelivr.net/gh/ysrim/bjcc_ss@main/images/avatar/archer_m.png" alt="ê¶ìˆ˜">
						<span>í‰ì•ˆì˜ ê¶ìˆ˜</span>
					</div>
					<div class="avatar-item" data-id="005">
						<img src="https://cdn.jsdelivr.net/gh/ysrim/bjcc_ss@main/images/avatar/wizard_m.png" alt="ë§ˆë²•ì‚¬">
						<span>ì§€í˜œì˜ ë§ˆë²•ì‚¬</span>
					</div>
					<div class="avatar-item" data-id="006">
						<img src="https://cdn.jsdelivr.net/gh/ysrim/bjcc_ss@main/images/avatar/healer_m.png" alt="íëŸ¬">
						<span>ì‚¬ë‘ì˜ íëŸ¬</span>
					</div>
					<div class="avatar-item" data-id="007">
						<img src="https://cdn.jsdelivr.net/gh/ysrim/bjcc_ss@main/images/avatar/druid_m.png" alt="íëŸ¬">
						<span>ì„±ì¥ì˜ ë“œë£¨ì´ë“œ</span>
					</div>
					<div class="avatar-item" data-id="008">
						<img src="https://cdn.jsdelivr.net/gh/ysrim/bjcc_ss@main/images/avatar/poet_m.png" alt="ìŒìœ ì‹œì¸">
						<span>ê¸°ì¨ì˜ ìŒìœ ì‹œì¸</span>
					</div>
				</div>
				<div style="display: flex; gap: 10px; margin-bottom: 10px;">
					<div style="flex: 1;">
						<label for="grade">í•™ë…„</label>
						<select th:field="*{grade}">
							<option value="4">4í•™ë…„</option>
							<option value="5">5í•™ë…„</option>
							<option value="6">6í•™ë…„</option>
						</select>
					</div>
					<div style="flex: 1;">
						<label for="cls">ë°˜</label>
						<select th:field="*{cls}">
							<option value="1">1ë°˜</option>
						</select>
					</div>
				</div>
				<button type="button" class="btn btn-main" id="btn-submit">ê°€ì… ì™„ë£Œ!</button>
			</div>
		</form>
	</div>
	<div id="custom-alert" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center;">
		<div class="card" style="max-width:320px; text-align:center; padding:30px; transform: scale(0.9); transition: transform 0.2s;">
			<div id="alert-icon" style="font-size: 3rem; margin-bottom: 15px;">âœ¨</div>
			<h4 id="alert-title" style="margin-bottom: 10px; color: var(--secondary);">ì•Œë¦¼</h4>
			<p id="alert-message" style="font-size: 0.95rem; color: #666; margin-bottom: 25px; line-height: 1.5; word-break: keep-all;"></p>
			<button class="btn btn-main custom-alert-confirm" style="margin-top:0;">í™•ì¸</button>
		</div>
	</div>
</div>
</body>
</html>